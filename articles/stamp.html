<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Stamp • stamp</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Stamp">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">stamp</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">0.0.6</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item"><a class="nav-link" href="../articles/stamp.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Basics</h6></li>
    <li><a class="dropdown-item" href="../articles/setup-and-basics.html">Setup and Basics</a></li>
    <li><a class="dropdown-item" href="../articles/hashing-and-versions.html">Hashing, Change Detection and Versions</a></li>
    <li><a class="dropdown-item" href="../articles/lineage-rebuilds.html">Lineage and Rebuilds</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Advanced Usage</h6></li>
    <li><a class="dropdown-item" href="../articles/builders-plans.html">Builders, Plans, and Rebuilds</a></li>
    <li><a class="dropdown-item" href="../articles/version_retention_prune.html">Version Retention, Pruning, and Table Metadata</a></li>
    <li><a class="dropdown-item" href="../articles/partitions.html">Working with Partitioned Datasets</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/randrescastaneda/stamp"><span class="fa fa-github"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Stamp</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/randrescastaneda/stamp/blob/master/vignettes/stamp.Rmd" class="external-link"><code>vignettes/stamp.Rmd</code></a></small>
      <div class="d-none name"><code>stamp.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 class="unnumbered" id="the-problem">The Problem<a class="anchor" aria-label="anchor" href="#the-problem"></a>
</h2>
<p>You have multiple input files produced by different processes. You
want to read, process, and save derived artifacts while capturing.</p>
<p>Let’s simulate the data and folder structure:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">"pkgload"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">pkgload</span><span class="fu">::</span><span class="fu"><a href="https://pkgload.r-lib.org/reference/load_all.html" class="external-link">load_all</a></span><span class="op">(</span><span class="st">"."</span><span class="op">)</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://randrescastaneda.github.io/stamp/">stamp</a></span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Loading <span style="color: #0000BB;">stamp</span></span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com" class="external-link">data.table</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create an isolated temporary root so all writes occur outside the package tree.</span></span>
<span><span class="co"># Use a short name to avoid long path issues on Windows (PATH_MAX = 260).</span></span>
<span><span class="va">root_dir</span> <span class="op">&lt;-</span> <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/file_temp.html" class="external-link">path_temp</a></span><span class="op">(</span><span class="st">"s"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/create.html" class="external-link">dir_create</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">old_wd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/getwd.html" class="external-link">setwd</a></span><span class="op">(</span><span class="va">root_dir</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/on.exit.html" class="external-link">on.exit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/getwd.html" class="external-link">setwd</a></span><span class="op">(</span><span class="va">old_wd</span><span class="op">)</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Initialize stamp under this temp root</span></span>
<span><span class="fu"><a href="../reference/st_init.html">st_init</a></span><span class="op">(</span>root <span class="op">=</span> <span class="va">root_dir</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> stamp initialized</span></span>
<span><span class="co">#&gt;   root: /tmp/RtmpSn2PpI/s</span></span>
<span><span class="co">#&gt;   state: /tmp/RtmpSn2PpI/s/.stamp</span></span>
<span></span>
<span><span class="co"># Define subdirectories (they will be created as needed)</span></span>
<span><span class="va">welfare_dir</span> <span class="op">&lt;-</span> <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path.html" class="external-link">path</a></span><span class="op">(</span><span class="va">root_dir</span>, <span class="st">"data"</span>, <span class="st">"welfare"</span><span class="op">)</span></span>
<span><span class="va">macro_dir</span> <span class="op">&lt;-</span> <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path.html" class="external-link">path</a></span><span class="op">(</span><span class="va">root_dir</span>, <span class="st">"data"</span>, <span class="st">"macro"</span><span class="op">)</span></span>
<span><span class="va">population_dir</span> <span class="op">&lt;-</span> <span class="va">macro_dir</span></span>
<span><span class="va">outputs_dir</span> <span class="op">&lt;-</span> <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path.html" class="external-link">path</a></span><span class="op">(</span><span class="va">root_dir</span>, <span class="st">"outputs"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/create.html" class="external-link">dir_create</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">welfare_parts_dir</span> <span class="op">&lt;-</span> <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path.html" class="external-link">path</a></span><span class="op">(</span><span class="va">root_dir</span>, <span class="st">"data"</span>, <span class="st">"welfare_parts"</span><span class="op">)</span></span>
<span><span class="va">summary_parts_dir</span> <span class="op">&lt;-</span> <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path.html" class="external-link">path</a></span><span class="op">(</span><span class="va">root_dir</span>, <span class="st">"outputs"</span>, <span class="st">"summary_parts"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/create.html" class="external-link">dir_create</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">welfare_dir</span>, <span class="va">macro_dir</span>, <span class="va">welfare_parts_dir</span>, <span class="va">summary_parts_dir</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Helper: list only data files with known extensions to avoid locks/sidecars</span></span>
<span><span class="va">data_files</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dir</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">f</span> <span class="op">&lt;-</span> <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/dir_ls.html" class="external-link">dir_ls</a></span><span class="op">(</span><span class="va">dir</span>, type <span class="op">=</span> <span class="st">"file"</span><span class="op">)</span></span>
<span>  <span class="va">ext</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/chartr.html" class="external-link">tolower</a></span><span class="op">(</span><span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path_file.html" class="external-link">path_ext</a></span><span class="op">(</span><span class="va">f</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">allowed</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"qs2"</span>, <span class="st">"qs"</span>, <span class="st">"rds"</span>, <span class="st">"csv"</span>, <span class="st">"fst"</span>, <span class="st">"json"</span><span class="op">)</span></span>
<span>  <span class="va">f</span><span class="op">[</span><span class="va">ext</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">allowed</span><span class="op">]</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 class="unnumbered" id="the-solution">The Solution<a class="anchor" aria-label="anchor" href="#the-solution"></a>
</h2>
<div class="section level3">
<h3 id="harmonizing-economic-indicators-with-versioning-lineage">Harmonizing Economic Indicators with Versioning &amp; Lineage<a class="anchor" aria-label="anchor" href="#harmonizing-economic-indicators-with-versioning-lineage"></a>
</h3>
<p>We walk through a realistic data engineering scenario: several
country/year micro datasets and macro indicators must be combined into a
standardized output table. We want:</p>
<ol style="list-style-type: decimal">
<li>Consistent saving, versioning, and timestamp metadata for each input
artifact.</li>
<li>Explicit primary keys (PK) recorded on disk.</li>
<li>A derived summary table saved with full lineage (parents
listed).</li>
<li>Demonstrating how a single input change propagates using
<code><a href="../reference/st_is_stale.html">st_is_stale()</a></code>, <code><a href="../reference/st_plan_rebuild.html">st_plan_rebuild()</a></code>, and
<code><a href="../reference/st_rebuild.html">st_rebuild()</a></code>.</li>
<li>Adding new data (ARG 2015) and observing minimal recomputation.</li>
<li>Producing the same output using partitioned artifacts for partial
re-runs.</li>
</ol>
<ul>
<li><p>Countries/years for welfare (micro) data: COL2010, COL2012,
MEX2010, MEX2015, PRY2011, PRY2014.</p></li>
<li>
<p>Reporting levels:</p>
<ul>
<li>COL and MEX: both <code>urban</code> and <code>rural</code>.</li>
<li>PRY: only <code>national</code>.</li>
</ul>
</li>
<li><p>Macro data (CPI, GDP, population) exist for COL, MEX, PRY, BRA,
ARG (2010–2015). CPI &amp; population have all three reporting levels
(<code>national</code>, <code>urban</code>, <code>rural</code>) for
every country-year.</p></li>
</ul>
</div>
<div class="section level3">
<h3 id="simulate-and-save-input-micro-data">1. Simulate and Save Input Micro Data<a class="anchor" aria-label="anchor" href="#simulate-and-save-input-micro-data"></a>
</h3>
<p>We’ll create small synthetic micro datasets with columns:
<code>country</code>, <code>year</code>, <code>reporting_level</code>,
<code>hh_id</code>, <code>welfare</code>, <code>weight</code>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/create.html" class="external-link">dir_create</a></span><span class="op">(</span><span class="va">welfare_dir</span><span class="op">)</span></span>
<span></span>
<span><span class="va">welfare_specs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  country <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"COL"</span>, <span class="st">"COL"</span>, <span class="st">"MEX"</span>, <span class="st">"MEX"</span>, <span class="st">"PRY"</span>, <span class="st">"PRY"</span><span class="op">)</span>,</span>
<span>  year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2010</span>, <span class="fl">2012</span>, <span class="fl">2010</span>, <span class="fl">2015</span>, <span class="fl">2011</span>, <span class="fl">2014</span><span class="op">)</span>,</span>
<span>  stringsAsFactors <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">mk_reporting</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">cty</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">cty</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"COL"</span>, <span class="st">"MEX"</span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"urban"</span>, <span class="st">"rural"</span><span class="op">)</span> <span class="kw">else</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"national"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">simulate_welfare</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">country</span>, <span class="va">year</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">rl</span> <span class="op">&lt;-</span> <span class="fu">mk_reporting</span><span class="op">(</span><span class="va">country</span><span class="op">)</span></span>
<span>  <span class="co"># 200 households per reporting level</span></span>
<span>  <span class="va">dt_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">rl</span>, <span class="kw">function</span><span class="op">(</span><span class="va">rlev</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">200L</span></span>
<span>    <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span></span>
<span>      country <span class="op">=</span> <span class="va">country</span>,</span>
<span>      year <span class="op">=</span> <span class="va">year</span>,</span>
<span>      reporting_level <span class="op">=</span> <span class="va">rlev</span>,</span>
<span>      hh_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%s_%s_%s_%03d"</span>, <span class="va">country</span>, <span class="va">year</span>, <span class="va">rlev</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      welfare <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/stats/Lognormal.html" class="external-link">rlnorm</a></span><span class="op">(</span><span class="va">n</span>, meanlog <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">1000</span> <span class="op">+</span> <span class="va">year</span><span class="op">)</span> <span class="op">-</span> <span class="fl">7</span>, sdlog <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>        <span class="fl">2</span></span>
<span>      <span class="op">)</span>,</span>
<span>      weight <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">0.5</span>, <span class="fl">2</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/rbindlist.html" class="external-link">rbindlist</a></span><span class="op">(</span><span class="va">dt_list</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">welfare_paths</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">welfare_specs</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">row</span> <span class="op">&lt;-</span> <span class="va">welfare_specs</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span></span>
<span>  <span class="va">dt</span> <span class="op">&lt;-</span> <span class="fu">simulate_welfare</span><span class="op">(</span><span class="va">row</span><span class="op">$</span><span class="va">country</span>, <span class="va">row</span><span class="op">$</span><span class="va">year</span><span class="op">)</span></span>
<span>  <span class="va">fn</span> <span class="op">&lt;-</span> <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path.html" class="external-link">path</a></span><span class="op">(</span><span class="va">welfare_dir</span>, <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%s_%d.qs2"</span>, <span class="va">row</span><span class="op">$</span><span class="va">country</span>, <span class="va">row</span><span class="op">$</span><span class="va">year</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="co"># Primary key columns include household id for uniqueness</span></span>
<span>  <span class="fu"><a href="../reference/st_save.html">st_save</a></span><span class="op">(</span></span>
<span>    <span class="va">dt</span>,</span>
<span>    <span class="va">fn</span>,</span>
<span>    pk <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"country"</span>, <span class="st">"year"</span>, <span class="st">"reporting_level"</span>, <span class="st">"hh_id"</span><span class="op">)</span>,</span>
<span>    domain <span class="op">=</span> <span class="st">"welfare"</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="va">welfare_paths</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">welfare_paths</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">fn</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Saved [<span style="color: #00BB00;">qs2</span>] → <span style="color: #0000BB;">/tmp/RtmpSn2PpI/s/data/welfare/COL_2010.qs2</span> @ version</span></span>
<span><span class="co">#&gt;   <span style="color: #00BB00;">75ad53d22bdc889c</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Saved [<span style="color: #00BB00;">qs2</span>] → <span style="color: #0000BB;">/tmp/RtmpSn2PpI/s/data/welfare/COL_2012.qs2</span> @ version</span></span>
<span><span class="co">#&gt;   <span style="color: #00BB00;">22a631e9cf4b654b</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Saved [<span style="color: #00BB00;">qs2</span>] → <span style="color: #0000BB;">/tmp/RtmpSn2PpI/s/data/welfare/MEX_2010.qs2</span> @ version</span></span>
<span><span class="co">#&gt;   <span style="color: #00BB00;">8cd1d3757fd8861e</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Saved [<span style="color: #00BB00;">qs2</span>] → <span style="color: #0000BB;">/tmp/RtmpSn2PpI/s/data/welfare/MEX_2015.qs2</span> @ version</span></span>
<span><span class="co">#&gt;   <span style="color: #00BB00;">5ae25a0f064c4022</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Saved [<span style="color: #00BB00;">qs2</span>] → <span style="color: #0000BB;">/tmp/RtmpSn2PpI/s/data/welfare/PRY_2011.qs2</span> @ version</span></span>
<span><span class="co">#&gt;   <span style="color: #00BB00;">1661f2a8e0925673</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Saved [<span style="color: #00BB00;">qs2</span>] → <span style="color: #0000BB;">/tmp/RtmpSn2PpI/s/data/welfare/PRY_2014.qs2</span> @ version</span></span>
<span><span class="co">#&gt;   <span style="color: #00BB00;">8515270d66067cfc</span></span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">welfare_paths</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "/tmp/RtmpSn2PpI/s/data/welfare/COL_2010.qs2"</span></span>
<span><span class="co">#&gt; [2] "/tmp/RtmpSn2PpI/s/data/welfare/COL_2012.qs2"</span></span>
<span><span class="co">#&gt; [3] "/tmp/RtmpSn2PpI/s/data/welfare/MEX_2010.qs2"</span></span>
<span><span class="co">#&gt; [4] "/tmp/RtmpSn2PpI/s/data/welfare/MEX_2015.qs2"</span></span>
<span><span class="co">#&gt; [5] "/tmp/RtmpSn2PpI/s/data/welfare/PRY_2011.qs2"</span></span>
<span><span class="co">#&gt; [6] "/tmp/RtmpSn2PpI/s/data/welfare/PRY_2014.qs2"</span></span></code></pre></div>
<p>Each call to <code><a href="../reference/st_save.html">st_save()</a></code> assigns a version id (if content
differs) and writes sidecar metadata including PK.</p>
<p>Inspect one artifact:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/st_info.html">st_info</a></span><span class="op">(</span><span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path.html" class="external-link">path</a></span><span class="op">(</span><span class="va">welfare_dir</span>, <span class="st">"COL_2010.qs2"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; $sidecar</span></span>
<span><span class="co">#&gt; $sidecar$path</span></span>
<span><span class="co">#&gt; [1] "/tmp/RtmpSn2PpI/s/data/welfare/COL_2010.qs2"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $sidecar$format</span></span>
<span><span class="co">#&gt; [1] "qs2"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $sidecar$created_at</span></span>
<span><span class="co">#&gt; [1] "2025-12-22T11:01:26.323109Z"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $sidecar$size_bytes</span></span>
<span><span class="co">#&gt; [1] 4803</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $sidecar$content_hash</span></span>
<span><span class="co">#&gt; [1] "883dbf2745b89d63"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $sidecar$code_hash</span></span>
<span><span class="co">#&gt; NULL</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $sidecar$file_hash</span></span>
<span><span class="co">#&gt; NULL</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $sidecar$code_label</span></span>
<span><span class="co">#&gt; NULL</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $sidecar$parents</span></span>
<span><span class="co">#&gt; list()</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $sidecar$attrs</span></span>
<span><span class="co">#&gt; list()</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $sidecar$pk</span></span>
<span><span class="co">#&gt; $sidecar$pk$keys</span></span>
<span><span class="co">#&gt; [1] "country"         "year"            "reporting_level" "hh_id"          </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $sidecar$domain</span></span>
<span><span class="co">#&gt; [1] "welfare"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $catalog</span></span>
<span><span class="co">#&gt; $catalog$latest_version_id</span></span>
<span><span class="co">#&gt; [1] "75ad53d22bdc889c"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $catalog$n_versions</span></span>
<span><span class="co">#&gt; [1] 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $snapshot_dir</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB; font-weight: bold;">/tmp/RtmpSn2PpI/s/.stamp/versions/data/welfare/COL_2010.qs2/75ad53d22bdc889c</span></span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $parents</span></span>
<span><span class="co">#&gt; list()</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="simulate-and-save-macro-data-cpi-gdp-population">2. Simulate and Save Macro Data (CPI, GDP, Population)<a class="anchor" aria-label="anchor" href="#simulate-and-save-macro-data-cpi-gdp-population"></a>
</h3>
<p>CPI &amp; population are reporting-level granular; GDP is
country-year only.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/create.html" class="external-link">dir_create</a></span><span class="op">(</span><span class="va">macro_dir</span><span class="op">)</span></span>
<span></span>
<span><span class="va">years</span> <span class="op">&lt;-</span> <span class="fl">2010</span><span class="op">:</span><span class="fl">2015</span></span>
<span><span class="va">countries_macro</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"COL"</span>, <span class="st">"MEX"</span>, <span class="st">"PRY"</span>, <span class="st">"BRA"</span>, <span class="st">"ARG"</span><span class="op">)</span></span>
<span><span class="va">levels_all</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"national"</span>, <span class="st">"urban"</span>, <span class="st">"rural"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">simulate_cpi</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/J.html" class="external-link">CJ</a></span><span class="op">(</span></span>
<span>    country <span class="op">=</span> <span class="va">countries_macro</span>,</span>
<span>    year <span class="op">=</span> <span class="va">years</span>,</span>
<span>    reporting_level <span class="op">=</span> <span class="va">levels_all</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="va">out</span><span class="op">[</span>, <span class="va">cpi</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">.N</span>, <span class="fl">80</span>, <span class="fl">140</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span><span class="op">]</span></span>
<span>  <span class="va">out</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">simulate_population</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/J.html" class="external-link">CJ</a></span><span class="op">(</span></span>
<span>    country <span class="op">=</span> <span class="va">countries_macro</span>,</span>
<span>    year <span class="op">=</span> <span class="va">years</span>,</span>
<span>    reporting_level <span class="op">=</span> <span class="va">levels_all</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="va">out</span><span class="op">[</span>, <span class="va">population</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">.N</span>, <span class="fl">5e5</span>, <span class="fl">20e6</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></span>
<span>  <span class="va">out</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">simulate_gdp</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/J.html" class="external-link">CJ</a></span><span class="op">(</span>country <span class="op">=</span> <span class="va">countries_macro</span>, year <span class="op">=</span> <span class="va">years</span><span class="op">)</span></span>
<span>  <span class="va">out</span><span class="op">[</span>, <span class="va">gdp</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">.N</span>, <span class="fl">1e9</span>, <span class="fl">5e11</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></span>
<span>  <span class="va">out</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">cpi</span> <span class="op">&lt;-</span> <span class="fu">simulate_cpi</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">pop</span> <span class="op">&lt;-</span> <span class="fu">simulate_population</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">gdp</span> <span class="op">&lt;-</span> <span class="fu">simulate_gdp</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/st_save.html">st_save</a></span><span class="op">(</span></span>
<span>  <span class="va">cpi</span>,</span>
<span>  <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path.html" class="external-link">path</a></span><span class="op">(</span><span class="va">macro_dir</span>, <span class="st">"cpi.qs2"</span><span class="op">)</span>,</span>
<span>  pk <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"country"</span>, <span class="st">"year"</span>, <span class="st">"reporting_level"</span><span class="op">)</span>,</span>
<span>  domain <span class="op">=</span> <span class="st">"macro"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Saved [<span style="color: #00BB00;">qs2</span>] →</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">/tmp/RtmpSn2PpI/s/data/macro/cpi.qs2</span> @ version <span style="color: #00BB00;">75a94b22ddbf0ca2</span></span></span>
<span><span class="fu"><a href="../reference/st_save.html">st_save</a></span><span class="op">(</span></span>
<span>  <span class="va">pop</span>,</span>
<span>  <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path.html" class="external-link">path</a></span><span class="op">(</span><span class="va">macro_dir</span>, <span class="st">"population.qs2"</span><span class="op">)</span>,</span>
<span>  pk <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"country"</span>, <span class="st">"year"</span>, <span class="st">"reporting_level"</span><span class="op">)</span>,</span>
<span>  domain <span class="op">=</span> <span class="st">"macro"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Saved [<span style="color: #00BB00;">qs2</span>] → <span style="color: #0000BB;">/tmp/RtmpSn2PpI/s/data/macro/population.qs2</span> @ version</span></span>
<span><span class="co">#&gt;   <span style="color: #00BB00;">5c212fac3a83dc1f</span></span></span>
<span><span class="fu"><a href="../reference/st_save.html">st_save</a></span><span class="op">(</span></span>
<span>  <span class="va">gdp</span>,</span>
<span>  <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path.html" class="external-link">path</a></span><span class="op">(</span><span class="va">macro_dir</span>, <span class="st">"gdp.qs2"</span><span class="op">)</span>,</span>
<span>  pk <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"country"</span>, <span class="st">"year"</span><span class="op">)</span>,</span>
<span>  domain <span class="op">=</span> <span class="st">"macro"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Saved [<span style="color: #00BB00;">qs2</span>] →</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">/tmp/RtmpSn2PpI/s/data/macro/gdp.qs2</span> @ version <span style="color: #00BB00;">0f3eb09ce38cedc6</span></span></span></code></pre></div>
<p>Version listing for CPI:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/st_versions.html">st_versions</a></span><span class="op">(</span><span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path.html" class="external-link">path</a></span><span class="op">(</span><span class="va">macro_dir</span>, <span class="st">"cpi.qs2"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="aggregation-function-foo-and-output-table">3. Aggregation Function <code>foo()</code> and Output Table<a class="anchor" aria-label="anchor" href="#aggregation-function-foo-and-output-table"></a>
</h3>
<p>We compute per <code>(country, year, reporting_level)</code> welfare
statistics and merge with CPI, GDP, population. We demonstrate loading
inputs inside the function for self-containment.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">foo</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Load all welfare micro artifacts (only recognized data files)</span></span>
<span>  <span class="va">welfare_files</span> <span class="op">&lt;-</span> <span class="fu">data_files</span><span class="op">(</span><span class="va">welfare_dir</span><span class="op">)</span></span>
<span>  <span class="va">wf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/rbindlist.html" class="external-link">rbindlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">welfare_files</span>, <span class="va">st_load</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">stats</span> <span class="op">&lt;-</span> <span class="va">wf</span><span class="op">[</span>,</span>
<span>    <span class="fu">.</span><span class="op">(</span></span>
<span>      welfare_mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/weighted.mean.html" class="external-link">weighted.mean</a></span><span class="op">(</span><span class="va">welfare</span>, <span class="va">weight</span><span class="op">)</span>,</span>
<span>      welfare_median <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">welfare</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      welfare_sd <span class="op">=</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">welfare</span><span class="op">)</span>,</span>
<span>      welfare_n <span class="op">=</span> <span class="va">.N</span></span>
<span>    <span class="op">)</span>,</span>
<span>    by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">country</span>, <span class="va">year</span>, <span class="va">reporting_level</span><span class="op">)</span></span>
<span>  <span class="op">]</span></span>
<span></span>
<span>  <span class="va">cpi</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/st_load.html">st_load</a></span><span class="op">(</span><span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path.html" class="external-link">path</a></span><span class="op">(</span><span class="va">macro_dir</span>, <span class="st">"cpi.qs2"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">gdp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/st_load.html">st_load</a></span><span class="op">(</span><span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path.html" class="external-link">path</a></span><span class="op">(</span><span class="va">macro_dir</span>, <span class="st">"gdp.qs2"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">pop</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/st_load.html">st_load</a></span><span class="op">(</span><span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path.html" class="external-link">path</a></span><span class="op">(</span><span class="va">macro_dir</span>, <span class="st">"population.qs2"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Merge; CPI &amp; population contain rows not present in welfare; keep welfare rows only</span></span>
<span>  <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html" class="external-link">merge</a></span><span class="op">(</span></span>
<span>    <span class="va">stats</span>,</span>
<span>    <span class="va">cpi</span>,</span>
<span>    by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"country"</span>, <span class="st">"year"</span>, <span class="st">"reporting_level"</span><span class="op">)</span>,</span>
<span>    all.x <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html" class="external-link">merge</a></span><span class="op">(</span></span>
<span>    <span class="va">out</span>,</span>
<span>    <span class="va">pop</span>,</span>
<span>    by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"country"</span>, <span class="st">"year"</span>, <span class="st">"reporting_level"</span><span class="op">)</span>,</span>
<span>    all.x <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html" class="external-link">merge</a></span><span class="op">(</span><span class="va">out</span>, <span class="va">gdp</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"country"</span>, <span class="st">"year"</span><span class="op">)</span>, all.x <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/setcolorder.html" class="external-link">setcolorder</a></span><span class="op">(</span></span>
<span>    <span class="va">out</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>      <span class="st">"country"</span>,</span>
<span>      <span class="st">"year"</span>,</span>
<span>      <span class="st">"reporting_level"</span>,</span>
<span>      <span class="st">"welfare_mean"</span>,</span>
<span>      <span class="st">"welfare_median"</span>,</span>
<span>      <span class="st">"welfare_sd"</span>,</span>
<span>      <span class="st">"welfare_n"</span>,</span>
<span>      <span class="st">"cpi"</span>,</span>
<span>      <span class="st">"gdp"</span>,</span>
<span>      <span class="st">"population"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="va">out</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">summary_table</span> <span class="op">&lt;-</span> <span class="fu">foo</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Loaded [<span style="color: #00BB00;">qs2</span>] ← <span style="color: #0000BB;">/tmp/RtmpSn2PpI/s/data/welfare/COL_2010.qs2</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Loaded [<span style="color: #00BB00;">qs2</span>] ← <span style="color: #0000BB;">/tmp/RtmpSn2PpI/s/data/welfare/COL_2012.qs2</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Loaded [<span style="color: #00BB00;">qs2</span>] ← <span style="color: #0000BB;">/tmp/RtmpSn2PpI/s/data/welfare/MEX_2010.qs2</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Loaded [<span style="color: #00BB00;">qs2</span>] ← <span style="color: #0000BB;">/tmp/RtmpSn2PpI/s/data/welfare/MEX_2015.qs2</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Loaded [<span style="color: #00BB00;">qs2</span>] ← <span style="color: #0000BB;">/tmp/RtmpSn2PpI/s/data/welfare/PRY_2011.qs2</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Loaded [<span style="color: #00BB00;">qs2</span>] ← <span style="color: #0000BB;">/tmp/RtmpSn2PpI/s/data/welfare/PRY_2014.qs2</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Loaded [<span style="color: #00BB00;">qs2</span>] ← <span style="color: #0000BB;">/tmp/RtmpSn2PpI/s/data/macro/cpi.qs2</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Loaded [<span style="color: #00BB00;">qs2</span>] ← <span style="color: #0000BB;">/tmp/RtmpSn2PpI/s/data/macro/gdp.qs2</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Loaded [<span style="color: #00BB00;">qs2</span>] ← <span style="color: #0000BB;">/tmp/RtmpSn2PpI/s/data/macro/population.qs2</span></span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">summary_table</span><span class="op">)</span></span>
<span><span class="co">#&gt; Key: &lt;country, year&gt;</span></span>
<span><span class="co">#&gt;    country  year reporting_level welfare_mean welfare_median welfare_sd</span></span>
<span><span class="co">#&gt;     &lt;char&gt; &lt;int&gt;          &lt;char&gt;        &lt;num&gt;          &lt;num&gt;      &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:     COL  2010           rural     3.188479          2.895   1.604006</span></span>
<span><span class="co">#&gt; 2:     COL  2010           urban     3.065242          2.665   1.681036</span></span>
<span><span class="co">#&gt; 3:     COL  2012           rural     3.196254          2.820   1.872963</span></span>
<span><span class="co">#&gt; 4:     COL  2012           urban     3.079524          2.750   1.627238</span></span>
<span><span class="co">#&gt; 5:     MEX  2010           rural     3.247370          2.775   1.696690</span></span>
<span><span class="co">#&gt; 6:     MEX  2010           urban     3.006862          2.710   1.606477</span></span>
<span><span class="co">#&gt;    welfare_n    cpi          gdp population</span></span>
<span><span class="co">#&gt;        &lt;int&gt;  &lt;num&gt;        &lt;num&gt;      &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:       200  92.71 449669674645   10746038</span></span>
<span><span class="co">#&gt; 2:       200  99.10 449669674645    5152778</span></span>
<span><span class="co">#&gt; 3:       200  93.11  55701684731    7761159</span></span>
<span><span class="co">#&gt; 4:       200 111.42  55701684731   15249755</span></span>
<span><span class="co">#&gt; 5:       200  93.68 384563952393    5367608</span></span>
<span><span class="co">#&gt; 6:       200 125.54 384563952393   12591517</span></span></code></pre></div>
<p>Save the summary with lineage: parents include all welfare micro
datasets plus CPI/GDP/population.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">parent_paths</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  <span class="fu">data_files</span><span class="op">(</span><span class="va">welfare_dir</span><span class="op">)</span>,</span>
<span>  <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path.html" class="external-link">path</a></span><span class="op">(</span><span class="va">macro_dir</span>, <span class="st">"cpi.qs2"</span><span class="op">)</span>,</span>
<span>  <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path.html" class="external-link">path</a></span><span class="op">(</span><span class="va">macro_dir</span>, <span class="st">"gdp.qs2"</span><span class="op">)</span>,</span>
<span>  <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path.html" class="external-link">path</a></span><span class="op">(</span><span class="va">macro_dir</span>, <span class="st">"population.qs2"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">parents</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">parent_paths</span>, <span class="kw">function</span><span class="op">(</span><span class="va">p</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>path <span class="op">=</span> <span class="va">p</span>, version_id <span class="op">=</span> <span class="fu"><a href="../reference/st_latest.html">st_latest</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="va">out_summary_path</span> <span class="op">&lt;-</span> <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path.html" class="external-link">path</a></span><span class="op">(</span><span class="va">outputs_dir</span>, <span class="st">"welfare_summary.qs2"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/st_save.html">st_save</a></span><span class="op">(</span></span>
<span>  <span class="va">summary_table</span>,</span>
<span>  <span class="va">out_summary_path</span>,</span>
<span>  pk <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"country"</span>, <span class="st">"year"</span>, <span class="st">"reporting_level"</span><span class="op">)</span>,</span>
<span>  parents <span class="op">=</span> <span class="va">parents</span>,</span>
<span>  domain <span class="op">=</span> <span class="st">"summary"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Saved [<span style="color: #00BB00;">qs2</span>] → <span style="color: #0000BB;">/tmp/RtmpSn2PpI/s/outputs/welfare_summary.qs2</span> @ version</span></span>
<span><span class="co">#&gt;   <span style="color: #00BB00;">2b148d64bdefae4a</span></span></span>
<span><span class="fu"><a href="../reference/st_lineage.html">st_lineage</a></span><span class="op">(</span><span class="va">out_summary_path</span>, depth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt;   level                                    child_path    child_version</span></span>
<span><span class="co">#&gt; 1     1 /tmp/RtmpSn2PpI/s/outputs/welfare_summary.qs2 2b148d64bdefae4a</span></span>
<span><span class="co">#&gt; 2     1 /tmp/RtmpSn2PpI/s/outputs/welfare_summary.qs2 2b148d64bdefae4a</span></span>
<span><span class="co">#&gt; 3     1 /tmp/RtmpSn2PpI/s/outputs/welfare_summary.qs2 2b148d64bdefae4a</span></span>
<span><span class="co">#&gt; 4     1 /tmp/RtmpSn2PpI/s/outputs/welfare_summary.qs2 2b148d64bdefae4a</span></span>
<span><span class="co">#&gt; 5     1 /tmp/RtmpSn2PpI/s/outputs/welfare_summary.qs2 2b148d64bdefae4a</span></span>
<span><span class="co">#&gt; 6     1 /tmp/RtmpSn2PpI/s/outputs/welfare_summary.qs2 2b148d64bdefae4a</span></span>
<span><span class="co">#&gt; 7     1 /tmp/RtmpSn2PpI/s/outputs/welfare_summary.qs2 2b148d64bdefae4a</span></span>
<span><span class="co">#&gt; 8     1 /tmp/RtmpSn2PpI/s/outputs/welfare_summary.qs2 2b148d64bdefae4a</span></span>
<span><span class="co">#&gt; 9     1 /tmp/RtmpSn2PpI/s/outputs/welfare_summary.qs2 2b148d64bdefae4a</span></span>
<span><span class="co">#&gt;                                   parent_path   parent_version</span></span>
<span><span class="co">#&gt; 1 /tmp/RtmpSn2PpI/s/data/welfare/COL_2010.qs2 75ad53d22bdc889c</span></span>
<span><span class="co">#&gt; 2 /tmp/RtmpSn2PpI/s/data/welfare/COL_2012.qs2 22a631e9cf4b654b</span></span>
<span><span class="co">#&gt; 3 /tmp/RtmpSn2PpI/s/data/welfare/MEX_2010.qs2 8cd1d3757fd8861e</span></span>
<span><span class="co">#&gt; 4 /tmp/RtmpSn2PpI/s/data/welfare/MEX_2015.qs2 5ae25a0f064c4022</span></span>
<span><span class="co">#&gt; 5 /tmp/RtmpSn2PpI/s/data/welfare/PRY_2011.qs2 1661f2a8e0925673</span></span>
<span><span class="co">#&gt; 6 /tmp/RtmpSn2PpI/s/data/welfare/PRY_2014.qs2 8515270d66067cfc</span></span>
<span><span class="co">#&gt; 7        /tmp/RtmpSn2PpI/s/data/macro/cpi.qs2 75a94b22ddbf0ca2</span></span>
<span><span class="co">#&gt; 8        /tmp/RtmpSn2PpI/s/data/macro/gdp.qs2 0f3eb09ce38cedc6</span></span>
<span><span class="co">#&gt; 9 /tmp/RtmpSn2PpI/s/data/macro/population.qs2 5c212fac3a83dc1f</span></span></code></pre></div>
<p>Note: to make provenance explicit, pass the producing function as
<code>code=</code> so <code><a href="../reference/st_save.html">st_save()</a></code> records the function hash.
Below we demonstrate both patterns: <code>foo()</code> loads its own
data, while <code>bar()</code> accepts pre-loaded objects and is saved
with <code>code = bar</code>.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Variant that accepts loaded objects (preferred for testability and clarity)</span></span>
<span><span class="va">bar</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">welfare_list</span>, <span class="va">cpi_tbl</span>, <span class="va">gdp_tbl</span>, <span class="va">pop_tbl</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">wf</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/rbindlist.html" class="external-link">rbindlist</a></span><span class="op">(</span><span class="va">welfare_list</span><span class="op">)</span></span>
<span>  <span class="va">stats</span> <span class="op">&lt;-</span> <span class="va">wf</span><span class="op">[</span>,</span>
<span>    <span class="fu">.</span><span class="op">(</span></span>
<span>      welfare_mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/weighted.mean.html" class="external-link">weighted.mean</a></span><span class="op">(</span><span class="va">welfare</span>, <span class="va">weight</span><span class="op">)</span>,</span>
<span>      welfare_median <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">welfare</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      welfare_sd <span class="op">=</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">welfare</span><span class="op">)</span>,</span>
<span>      welfare_n <span class="op">=</span> <span class="va">.N</span></span>
<span>    <span class="op">)</span>,</span>
<span>    by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">country</span>, <span class="va">year</span>, <span class="va">reporting_level</span><span class="op">)</span></span>
<span>  <span class="op">]</span></span>
<span></span>
<span>  <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html" class="external-link">merge</a></span><span class="op">(</span></span>
<span>    <span class="va">stats</span>,</span>
<span>    <span class="va">cpi_tbl</span>,</span>
<span>    by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"country"</span>, <span class="st">"year"</span>, <span class="st">"reporting_level"</span><span class="op">)</span>,</span>
<span>    all.x <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html" class="external-link">merge</a></span><span class="op">(</span></span>
<span>    <span class="va">out</span>,</span>
<span>    <span class="va">pop_tbl</span>,</span>
<span>    by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"country"</span>, <span class="st">"year"</span>, <span class="st">"reporting_level"</span><span class="op">)</span>,</span>
<span>    all.x <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html" class="external-link">merge</a></span><span class="op">(</span><span class="va">out</span>, <span class="va">gdp_tbl</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"country"</span>, <span class="st">"year"</span><span class="op">)</span>, all.x <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/setcolorder.html" class="external-link">setcolorder</a></span><span class="op">(</span></span>
<span>    <span class="va">out</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>      <span class="st">"country"</span>,</span>
<span>      <span class="st">"year"</span>,</span>
<span>      <span class="st">"reporting_level"</span>,</span>
<span>      <span class="st">"welfare_mean"</span>,</span>
<span>      <span class="st">"welfare_median"</span>,</span>
<span>      <span class="st">"welfare_sd"</span>,</span>
<span>      <span class="st">"welfare_n"</span>,</span>
<span>      <span class="st">"cpi"</span>,</span>
<span>      <span class="st">"gdp"</span>,</span>
<span>      <span class="st">"population"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="va">out</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Example: load inputs outside the worker and call bar()</span></span>
<span><span class="va">welfare_files</span> <span class="op">&lt;-</span> <span class="fu">data_files</span><span class="op">(</span><span class="va">welfare_dir</span><span class="op">)</span></span>
<span><span class="va">welfare_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">welfare_files</span>, <span class="va">st_load</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Loaded [<span style="color: #00BB00;">qs2</span>] ← <span style="color: #0000BB;">/tmp/RtmpSn2PpI/s/data/welfare/COL_2010.qs2</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Loaded [<span style="color: #00BB00;">qs2</span>] ← <span style="color: #0000BB;">/tmp/RtmpSn2PpI/s/data/welfare/COL_2012.qs2</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Loaded [<span style="color: #00BB00;">qs2</span>] ← <span style="color: #0000BB;">/tmp/RtmpSn2PpI/s/data/welfare/MEX_2010.qs2</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Loaded [<span style="color: #00BB00;">qs2</span>] ← <span style="color: #0000BB;">/tmp/RtmpSn2PpI/s/data/welfare/MEX_2015.qs2</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Loaded [<span style="color: #00BB00;">qs2</span>] ← <span style="color: #0000BB;">/tmp/RtmpSn2PpI/s/data/welfare/PRY_2011.qs2</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Loaded [<span style="color: #00BB00;">qs2</span>] ← <span style="color: #0000BB;">/tmp/RtmpSn2PpI/s/data/welfare/PRY_2014.qs2</span></span></span>
<span><span class="va">cpi_tbl</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/st_load.html">st_load</a></span><span class="op">(</span><span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path.html" class="external-link">path</a></span><span class="op">(</span><span class="va">macro_dir</span>, <span class="st">"cpi.qs2"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Loaded [<span style="color: #00BB00;">qs2</span>] ←</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">/tmp/RtmpSn2PpI/s/data/macro/cpi.qs2</span></span></span>
<span><span class="va">gdp_tbl</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/st_load.html">st_load</a></span><span class="op">(</span><span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path.html" class="external-link">path</a></span><span class="op">(</span><span class="va">macro_dir</span>, <span class="st">"gdp.qs2"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Loaded [<span style="color: #00BB00;">qs2</span>] ←</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">/tmp/RtmpSn2PpI/s/data/macro/gdp.qs2</span></span></span>
<span><span class="va">pop_tbl</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/st_load.html">st_load</a></span><span class="op">(</span><span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path.html" class="external-link">path</a></span><span class="op">(</span><span class="va">macro_dir</span>, <span class="st">"population.qs2"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Loaded [<span style="color: #00BB00;">qs2</span>] ←</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">/tmp/RtmpSn2PpI/s/data/macro/population.qs2</span></span></span>
<span></span>
<span><span class="va">summary_table2</span> <span class="op">&lt;-</span> <span class="fu">bar</span><span class="op">(</span><span class="va">welfare_list</span>, <span class="va">cpi_tbl</span>, <span class="va">gdp_tbl</span>, <span class="va">pop_tbl</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/st_save.html">st_save</a></span><span class="op">(</span></span>
<span>  <span class="va">summary_table2</span>,</span>
<span>  <span class="va">out_summary_path</span>,</span>
<span>  pk <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"country"</span>, <span class="st">"year"</span>, <span class="st">"reporting_level"</span><span class="op">)</span>,</span>
<span>  parents <span class="op">=</span> <span class="va">parents</span>,</span>
<span>  code <span class="op">=</span> <span class="va">bar</span>, <span class="co"># addition the function as parent so st_save() can track it</span></span>
<span>  domain <span class="op">=</span> <span class="st">"summary"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Saved [<span style="color: #00BB00;">qs2</span>] → <span style="color: #0000BB;">/tmp/RtmpSn2PpI/s/outputs/welfare_summary.qs2</span> @ version</span></span>
<span><span class="co">#&gt;   <span style="color: #00BB00;">774500cf09b41ae5</span></span></span>
<span><span class="fu"><a href="../reference/st_lineage.html">st_lineage</a></span><span class="op">(</span><span class="va">out_summary_path</span>, depth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt;   level                                    child_path    child_version</span></span>
<span><span class="co">#&gt; 1     1 /tmp/RtmpSn2PpI/s/outputs/welfare_summary.qs2 774500cf09b41ae5</span></span>
<span><span class="co">#&gt; 2     1 /tmp/RtmpSn2PpI/s/outputs/welfare_summary.qs2 774500cf09b41ae5</span></span>
<span><span class="co">#&gt; 3     1 /tmp/RtmpSn2PpI/s/outputs/welfare_summary.qs2 774500cf09b41ae5</span></span>
<span><span class="co">#&gt; 4     1 /tmp/RtmpSn2PpI/s/outputs/welfare_summary.qs2 774500cf09b41ae5</span></span>
<span><span class="co">#&gt; 5     1 /tmp/RtmpSn2PpI/s/outputs/welfare_summary.qs2 774500cf09b41ae5</span></span>
<span><span class="co">#&gt; 6     1 /tmp/RtmpSn2PpI/s/outputs/welfare_summary.qs2 774500cf09b41ae5</span></span>
<span><span class="co">#&gt; 7     1 /tmp/RtmpSn2PpI/s/outputs/welfare_summary.qs2 774500cf09b41ae5</span></span>
<span><span class="co">#&gt; 8     1 /tmp/RtmpSn2PpI/s/outputs/welfare_summary.qs2 774500cf09b41ae5</span></span>
<span><span class="co">#&gt; 9     1 /tmp/RtmpSn2PpI/s/outputs/welfare_summary.qs2 774500cf09b41ae5</span></span>
<span><span class="co">#&gt;                                   parent_path   parent_version</span></span>
<span><span class="co">#&gt; 1 /tmp/RtmpSn2PpI/s/data/welfare/COL_2010.qs2 75ad53d22bdc889c</span></span>
<span><span class="co">#&gt; 2 /tmp/RtmpSn2PpI/s/data/welfare/COL_2012.qs2 22a631e9cf4b654b</span></span>
<span><span class="co">#&gt; 3 /tmp/RtmpSn2PpI/s/data/welfare/MEX_2010.qs2 8cd1d3757fd8861e</span></span>
<span><span class="co">#&gt; 4 /tmp/RtmpSn2PpI/s/data/welfare/MEX_2015.qs2 5ae25a0f064c4022</span></span>
<span><span class="co">#&gt; 5 /tmp/RtmpSn2PpI/s/data/welfare/PRY_2011.qs2 1661f2a8e0925673</span></span>
<span><span class="co">#&gt; 6 /tmp/RtmpSn2PpI/s/data/welfare/PRY_2014.qs2 8515270d66067cfc</span></span>
<span><span class="co">#&gt; 7        /tmp/RtmpSn2PpI/s/data/macro/cpi.qs2 75a94b22ddbf0ca2</span></span>
<span><span class="co">#&gt; 8        /tmp/RtmpSn2PpI/s/data/macro/gdp.qs2 0f3eb09ce38cedc6</span></span>
<span><span class="co">#&gt; 9 /tmp/RtmpSn2PpI/s/data/macro/population.qs2 5c212fac3a83dc1f</span></span></code></pre></div>
<p>Handling multiple function dependencies</p>
<p>If the output depends on more than one function (for example
<code>foo()</code> calls <code>f1()</code> and <code>f2()</code>), you
can provide a combined <code>code</code> metadata to
<code><a href="../reference/st_save.html">st_save()</a></code> that captures all producing functions.
<code><a href="../reference/st_save.html">st_save()</a></code> accepts any object for <code>code</code>; best
practice is to pass a short list of the functions involved,
e.g. <code>code = list(foo = foo, helper1 = f1, helper2 = f2)</code>.
The package hashes <code>code</code> and records a
<code>code_hash</code> in the sidecar so downstream
<code><a href="../reference/st_is_stale.html">st_is_stale()</a></code> can detect changes in any contributor.</p>
<p>Example pattern:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Provide multiple functions to st_save so code_hash changes if any of them change</span></span>
<span><span class="co"># st_save(x, path, code = list(foo = foo, helper1 = f1, helper2 = f2))</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="modify-cpi-col-2012-new-version-staleness">4. Modify CPI (COL 2012) → New Version &amp; Staleness<a class="anchor" aria-label="anchor" href="#modify-cpi-col-2012-new-version-staleness"></a>
</h3>
<p>We change CPI for COL 2012 (all reporting levels) to illustrate a new
version and stale downstream artifact.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cpi2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/st_load.html">st_load</a></span><span class="op">(</span><span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path.html" class="external-link">path</a></span><span class="op">(</span><span class="va">macro_dir</span>, <span class="st">"cpi.qs2"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Loaded [<span style="color: #00BB00;">qs2</span>] ←</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">/tmp/RtmpSn2PpI/s/data/macro/cpi.qs2</span></span></span>
<span><span class="va">cpi2</span><span class="op">[</span><span class="va">country</span> <span class="op">==</span> <span class="st">"COL"</span> <span class="op">&amp;</span> <span class="va">year</span> <span class="op">==</span> <span class="fl">2012</span>, <span class="va">cpi</span> <span class="op">:=</span> <span class="va">cpi</span> <span class="op">*</span> <span class="fl">1.05</span><span class="op">]</span> <span class="co"># 5% adjustment</span></span>
<span><span class="fu"><a href="../reference/st_save.html">st_save</a></span><span class="op">(</span><span class="va">cpi2</span>, <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path.html" class="external-link">path</a></span><span class="op">(</span><span class="va">macro_dir</span>, <span class="st">"cpi.qs2"</span><span class="op">)</span><span class="op">)</span> <span class="co"># new version recorded</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Saved [<span style="color: #00BB00;">qs2</span>] →</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">/tmp/RtmpSn2PpI/s/data/macro/cpi.qs2</span> @ version <span style="color: #00BB00;">7d301454602ecbd6</span></span></span>
<span><span class="fu"><a href="../reference/st_versions.html">st_versions</a></span><span class="op">(</span><span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path.html" class="external-link">path</a></span><span class="op">(</span><span class="va">macro_dir</span>, <span class="st">"cpi.qs2"</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span></span>
<span><span class="co">#&gt;          version_id      artifact_id     content_hash code_hash size_bytes</span></span>
<span><span class="co">#&gt;              &lt;char&gt;           &lt;char&gt;           &lt;char&gt;    &lt;char&gt;      &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1: 7d301454602ecbd6 2f3e54a46f3de65a 7ecab5cc3c1c678f      &lt;NA&gt;        890</span></span>
<span><span class="co">#&gt; 2: 75a94b22ddbf0ca2 2f3e54a46f3de65a a0a1d1f0acc4fb3a      &lt;NA&gt;        874</span></span>
<span><span class="co">#&gt; 3:             &lt;NA&gt;             &lt;NA&gt;             &lt;NA&gt;      &lt;NA&gt;         NA</span></span>
<span><span class="co">#&gt;                     created_at sidecar_format</span></span>
<span><span class="co">#&gt;                         &lt;char&gt;         &lt;char&gt;</span></span>
<span><span class="co">#&gt; 1: 2025-12-22T11:01:27.979066Z           json</span></span>
<span><span class="co">#&gt; 2: 2025-12-22T11:01:26.888534Z           json</span></span>
<span><span class="co">#&gt; 3:                        &lt;NA&gt;           &lt;NA&gt;</span></span>
<span><span class="fu"><a href="../reference/st_is_stale.html">st_is_stale</a></span><span class="op">(</span><span class="va">out_summary_path</span><span class="op">)</span> <span class="co"># should be TRUE</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="builders-plans-and-rebuilds-concepts-and-how-we-use-them-here">Builders, plans and rebuilds — concepts and how we use them
here<a class="anchor" aria-label="anchor" href="#builders-plans-and-rebuilds-concepts-and-how-we-use-them-here"></a>
</h3>
<p>A short glossary and explanation of the concepts used in the examples
above:</p>
<ul>
<li><p><strong>Artifact</strong>: a saved object on disk (one path
managed by stamp).</p></li>
<li><p><strong>Sidecar</strong>: metadata file beside each artifact
(PKs, parents, code hash, domain, timestamps).</p></li>
<li><p><strong>Version</strong>: immutable snapshot; new version id
recorded when <code><a href="../reference/st_save.html">st_save()</a></code> detects changed content.</p></li>
<li><p><strong>Parent</strong>: pointer (path + version_id) to an
upstream artifact used to produce a downstream artifact.</p></li>
<li><p><strong>Lineage</strong>: directed graph linking artifacts via
parent relationships; inspect with <code><a href="../reference/st_lineage.html">st_lineage()</a></code>.</p></li>
<li><p><strong>Builder</strong>: function registered with
<code>st_register_builder(path, builder_fn)</code> that knows how to
produce one artifact. Returns at least <code>x</code> (object to save)
and <code>code</code> (function(s) used) so code changes trigger
staleness.</p></li>
<li><p><strong>Plan</strong>: result of <code><a href="../reference/st_plan_rebuild.html">st_plan_rebuild()</a></code>
describing which targets are stale (parents changed, code changed, or
artifact missing) and thus need rebuilding.</p></li>
<li><p><strong>Rebuild</strong>: executing a plan via
<code>st_rebuild(plan)</code>; runs builders, saves artifacts, updates
sidecars/versions.</p></li>
</ul>
<p>General idea - Register builders for reproducible targets. Builders
should be deterministic and return the object to save (do not save
directly inside the builder). - Use <code><a href="../reference/st_plan_rebuild.html">st_plan_rebuild()</a></code> to
compute what needs to be rebuilt (it inspects recorded parents and code
hashes). - Inspect the plan, then call <code><a href="../reference/st_rebuild.html">st_rebuild()</a></code> to
execute builders and record new versions.</p>
<p>How this vignette implements those ideas - We register a builder for
<code>out_summary_path</code> (see the
<code><a href="../reference/st_register_builder.html">st_register_builder()</a></code> call below). That builder returns
<code>list(x = foo(), code = foo, code_label = "aggregate_welfare")</code>.
- <code><a href="../reference/st_plan_rebuild.html">st_plan_rebuild()</a></code> compares current parent version ids and
the code hash of <code>foo</code> against what the sidecar recorded; if
any parent or code changed the plan will mark the target as stale. -
<code>st_rebuild(plan)</code> calls the registered builder, then
<code><a href="../reference/st_save.html">st_save()</a></code> persistently records the new artifact and sidecar
(including the new <code>code_hash</code> and parent pointers). - This
flow gives you a lightweight, auditable, and incremental pipeline:
change an upstream artifact or a function and the plan will tell you
what to rebuild.</p>
<p>Practical tips and a small example - Builders should prefer to use
the <code>parents</code> argument passed in (this avoids global state
and makes builders easier to test). - If your target depends on multiple
functions, pass them all in <code>code</code> so <code><a href="../reference/st_save.html">st_save()</a></code>
records a combined code hash:
<code>code = list(foo = foo, helper = f1)</code>.</p>
<p>Example builder that loads parents explicitly and returns multiple
functions in <code>code</code>:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Example: register a builder that uses the provided `parents` list and avoids global loads</span></span>
<span><span class="fu"><a href="../reference/st_register_builder.html">st_register_builder</a></span><span class="op">(</span><span class="va">out_summary_path</span>, <span class="kw">function</span><span class="op">(</span><span class="va">path</span>, <span class="va">parents</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># parents is a list of lists: each element has $path and $version_id</span></span>
<span>  <span class="co"># Filter parent paths to identify welfare partitions vs macros, then load them</span></span>
<span>  <span class="va">welfare_parent_paths</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">vapply</a></span><span class="op">(</span></span>
<span>    <span class="va">parents</span>,</span>
<span>    <span class="kw">function</span><span class="op">(</span><span class="va">p</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"welfare"</span>, <span class="va">p</span><span class="op">$</span><span class="va">path</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/logical.html" class="external-link">logical</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="va">welfare_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">parents</span><span class="op">[</span><span class="va">welfare_parent_paths</span><span class="op">]</span>, <span class="kw">function</span><span class="op">(</span><span class="va">p</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="../reference/st_load.html">st_load</a></span><span class="op">(</span><span class="va">p</span><span class="op">$</span><span class="va">path</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">cpi_tbl</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/st_load.html">st_load</a></span><span class="op">(</span><span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path.html" class="external-link">path</a></span><span class="op">(</span><span class="va">macro_dir</span>, <span class="st">"cpi.qs2"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">gdp_tbl</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/st_load.html">st_load</a></span><span class="op">(</span><span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path.html" class="external-link">path</a></span><span class="op">(</span><span class="va">macro_dir</span>, <span class="st">"gdp.qs2"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">pop_tbl</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/st_load.html">st_load</a></span><span class="op">(</span><span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path.html" class="external-link">path</a></span><span class="op">(</span><span class="va">macro_dir</span>, <span class="st">"population.qs2"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Produce the output using a helper function (bar) that accepts pre-loaded inputs</span></span>
<span>  <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu">bar</span><span class="op">(</span><span class="va">welfare_list</span>, <span class="va">cpi_tbl</span>, <span class="va">gdp_tbl</span>, <span class="va">pop_tbl</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Return the produced object plus code metadata (capture both producer and helpers)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="va">out</span>,</span>
<span>    code <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>bar <span class="op">=</span> <span class="va">bar</span><span class="op">)</span>, <span class="co"># include helpers as needed</span></span>
<span>    code_label <span class="op">=</span> <span class="st">"aggregate_welfare_partitioned"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Registered builder for <span style="color: #00BB00;">/tmp/RtmpSn2PpI/s/outputs/welfare_summary.qs2</span></span></span>
<span><span class="co">#&gt;   (<span style="color: #00BB00;">default</span>)</span></span></code></pre></div>
<p>Inspect the plan before running it:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plan</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/st_plan_rebuild.html">st_plan_rebuild</a></span><span class="op">(</span></span>
<span>  targets <span class="op">=</span> <span class="va">out_summary_path</span>,</span>
<span>  include_targets <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  mode <span class="op">=</span> <span class="st">"strict"</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">plan</span><span class="op">)</span></span>
<span><span class="co">#&gt;   level                                          path         reason</span></span>
<span><span class="co">#&gt; 1     0 /tmp/RtmpSn2PpI/s/outputs/welfare_summary.qs2 parent_changed</span></span>
<span><span class="co">#&gt;   latest_version_before</span></span>
<span><span class="co">#&gt; 1      774500cf09b41ae5</span></span></code></pre></div>
<p>Run the plan to execute the builders and record new versions:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/st_rebuild.html">st_rebuild</a></span><span class="op">(</span><span class="va">plan</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Rebuild level <span style="color: #00BB00;">0</span>: 1 artifact</span></span>
<span><span class="co">#&gt;   • <span style="color: #00BB00;">/tmp/RtmpSn2PpI/s/outputs/welfare_summary.qs2</span> (<span style="color: #00BB00;">parent_changed</span>)</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Loaded [<span style="color: #00BB00;">qs2</span>] ← <span style="color: #0000BB;">/tmp/RtmpSn2PpI/s/data/welfare/COL_2010.qs2</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Loaded [<span style="color: #00BB00;">qs2</span>] ← <span style="color: #0000BB;">/tmp/RtmpSn2PpI/s/data/welfare/COL_2012.qs2</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Loaded [<span style="color: #00BB00;">qs2</span>] ← <span style="color: #0000BB;">/tmp/RtmpSn2PpI/s/data/welfare/MEX_2010.qs2</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Loaded [<span style="color: #00BB00;">qs2</span>] ← <span style="color: #0000BB;">/tmp/RtmpSn2PpI/s/data/welfare/MEX_2015.qs2</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Loaded [<span style="color: #00BB00;">qs2</span>] ← <span style="color: #0000BB;">/tmp/RtmpSn2PpI/s/data/welfare/PRY_2011.qs2</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Loaded [<span style="color: #00BB00;">qs2</span>] ← <span style="color: #0000BB;">/tmp/RtmpSn2PpI/s/data/welfare/PRY_2014.qs2</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Loaded [<span style="color: #00BB00;">qs2</span>] ← <span style="color: #0000BB;">/tmp/RtmpSn2PpI/s/data/macro/cpi.qs2</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Loaded [<span style="color: #00BB00;">qs2</span>] ← <span style="color: #0000BB;">/tmp/RtmpSn2PpI/s/data/macro/gdp.qs2</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Loaded [<span style="color: #00BB00;">qs2</span>] ← <span style="color: #0000BB;">/tmp/RtmpSn2PpI/s/data/macro/population.qs2</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Saved [<span style="color: #00BB00;">qs2</span>] → <span style="color: #0000BB;">/tmp/RtmpSn2PpI/s/outputs/welfare_summary.qs2</span> @ version</span></span>
<span><span class="co">#&gt;   <span style="color: #00BB00;">81e0cee6f20a21ea</span></span></span>
<span><span class="co">#&gt; OK @ version <span style="color: #00BB00;">81e0cee6f20a21ea</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Rebuild summary</span></span>
<span><span class="co">#&gt;   built 1</span></span></code></pre></div>
<p>This example shows the recommended pattern: load from
<code>parents</code>, call a pure worker (like <code>bar()</code>), and
return <code>x</code> and <code>code</code>. That ensures
<code><a href="../reference/st_rebuild.html">st_rebuild()</a></code> can uniformly save artifacts, record lineage,
and compute <code>code_hash</code> changes for future incremental
rebuilds.</p>
<p>Plan &amp; rebuild using a registered builder for the summary
artifact.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/st_register_builder.html">st_register_builder</a></span><span class="op">(</span><span class="va">out_summary_path</span>, <span class="kw">function</span><span class="op">(</span><span class="va">path</span>, <span class="va">parents</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu">foo</span><span class="op">(</span><span class="op">)</span>, code <span class="op">=</span> <span class="va">foo</span>, code_label <span class="op">=</span> <span class="st">"aggregate_welfare"</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Registered builder for <span style="color: #00BB00;">/tmp/RtmpSn2PpI/s/outputs/welfare_summary.qs2</span></span></span>
<span><span class="co">#&gt;   (<span style="color: #00BB00;">default</span>)</span></span>
<span></span>
<span><span class="va">plan</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/st_plan_rebuild.html">st_plan_rebuild</a></span><span class="op">(</span></span>
<span>  targets <span class="op">=</span> <span class="va">out_summary_path</span>,</span>
<span>  include_targets <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  mode <span class="op">=</span> <span class="st">"strict"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">plan</span></span>
<span><span class="co">#&gt; [1] level                 path                  reason               </span></span>
<span><span class="co">#&gt; [4] latest_version_before</span></span>
<span><span class="co">#&gt; &lt;0 rows&gt; (or 0-length row.names)</span></span>
<span><span class="fu"><a href="../reference/st_rebuild.html">st_rebuild</a></span><span class="op">(</span><span class="va">plan</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Nothing to rebuild (empty plan).</span></span>
<span><span class="fu"><a href="../reference/st_lineage.html">st_lineage</a></span><span class="op">(</span><span class="va">out_summary_path</span>, depth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt;   level                                    child_path    child_version</span></span>
<span><span class="co">#&gt; 1     1 /tmp/RtmpSn2PpI/s/outputs/welfare_summary.qs2 81e0cee6f20a21ea</span></span>
<span><span class="co">#&gt; 2     1 /tmp/RtmpSn2PpI/s/outputs/welfare_summary.qs2 81e0cee6f20a21ea</span></span>
<span><span class="co">#&gt; 3     1 /tmp/RtmpSn2PpI/s/outputs/welfare_summary.qs2 81e0cee6f20a21ea</span></span>
<span><span class="co">#&gt; 4     1 /tmp/RtmpSn2PpI/s/outputs/welfare_summary.qs2 81e0cee6f20a21ea</span></span>
<span><span class="co">#&gt; 5     1 /tmp/RtmpSn2PpI/s/outputs/welfare_summary.qs2 81e0cee6f20a21ea</span></span>
<span><span class="co">#&gt; 6     1 /tmp/RtmpSn2PpI/s/outputs/welfare_summary.qs2 81e0cee6f20a21ea</span></span>
<span><span class="co">#&gt; 7     1 /tmp/RtmpSn2PpI/s/outputs/welfare_summary.qs2 81e0cee6f20a21ea</span></span>
<span><span class="co">#&gt; 8     1 /tmp/RtmpSn2PpI/s/outputs/welfare_summary.qs2 81e0cee6f20a21ea</span></span>
<span><span class="co">#&gt; 9     1 /tmp/RtmpSn2PpI/s/outputs/welfare_summary.qs2 81e0cee6f20a21ea</span></span>
<span><span class="co">#&gt;                                   parent_path   parent_version</span></span>
<span><span class="co">#&gt; 1 /tmp/RtmpSn2PpI/s/data/welfare/COL_2010.qs2 75ad53d22bdc889c</span></span>
<span><span class="co">#&gt; 2 /tmp/RtmpSn2PpI/s/data/welfare/COL_2012.qs2 22a631e9cf4b654b</span></span>
<span><span class="co">#&gt; 3 /tmp/RtmpSn2PpI/s/data/welfare/MEX_2010.qs2 8cd1d3757fd8861e</span></span>
<span><span class="co">#&gt; 4 /tmp/RtmpSn2PpI/s/data/welfare/MEX_2015.qs2 5ae25a0f064c4022</span></span>
<span><span class="co">#&gt; 5 /tmp/RtmpSn2PpI/s/data/welfare/PRY_2011.qs2 1661f2a8e0925673</span></span>
<span><span class="co">#&gt; 6 /tmp/RtmpSn2PpI/s/data/welfare/PRY_2014.qs2 8515270d66067cfc</span></span>
<span><span class="co">#&gt; 7        /tmp/RtmpSn2PpI/s/data/macro/cpi.qs2 7d301454602ecbd6</span></span>
<span><span class="co">#&gt; 8        /tmp/RtmpSn2PpI/s/data/macro/gdp.qs2 0f3eb09ce38cedc6</span></span>
<span><span class="co">#&gt; 9 /tmp/RtmpSn2PpI/s/data/macro/population.qs2 5c212fac3a83dc1f</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="add-new-data-arg-2015-welfare">5. Add New Data (ARG 2015 Welfare)<a class="anchor" aria-label="anchor" href="#add-new-data-arg-2015-welfare"></a>
</h3>
<p>We introduce a new welfare dataset (ARG 2015) which appears in macro
tables already. Only the summary rows for ARG 2015 will be newly
added.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dt_arg_2015</span> <span class="op">&lt;-</span> <span class="fu">simulate_welfare</span><span class="op">(</span><span class="st">"ARG"</span>, <span class="fl">2015</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/st_save.html">st_save</a></span><span class="op">(</span></span>
<span>  <span class="va">dt_arg_2015</span>,</span>
<span>  <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path.html" class="external-link">path</a></span><span class="op">(</span><span class="va">welfare_dir</span>, <span class="st">"ARG_2015.qs2"</span><span class="op">)</span>,</span>
<span>  pk <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"country"</span>, <span class="st">"year"</span>, <span class="st">"reporting_level"</span>, <span class="st">"hh_id"</span><span class="op">)</span>,</span>
<span>  domain <span class="op">=</span> <span class="st">"welfare"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Saved [<span style="color: #00BB00;">qs2</span>] → <span style="color: #0000BB;">/tmp/RtmpSn2PpI/s/data/welfare/ARG_2015.qs2</span> @ version</span></span>
<span><span class="co">#&gt;   <span style="color: #00BB00;">16a8fd2c4d6bf395</span></span></span>
<span></span>
<span><span class="va">parents2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="fu">data_files</span><span class="op">(</span><span class="va">welfare_dir</span><span class="op">)</span>,</span>
<span>    <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path.html" class="external-link">path</a></span><span class="op">(</span><span class="va">macro_dir</span>, <span class="st">"cpi.qs2"</span><span class="op">)</span>,</span>
<span>    <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path.html" class="external-link">path</a></span><span class="op">(</span><span class="va">macro_dir</span>, <span class="st">"gdp.qs2"</span><span class="op">)</span>,</span>
<span>    <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path.html" class="external-link">path</a></span><span class="op">(</span><span class="va">macro_dir</span>, <span class="st">"population.qs2"</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">p</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>path <span class="op">=</span> <span class="va">p</span>, version_id <span class="op">=</span> <span class="fu"><a href="../reference/st_latest.html">st_latest</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/st_save.html">st_save</a></span><span class="op">(</span></span>
<span>  <span class="fu">foo</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="va">out_summary_path</span>,</span>
<span>  pk <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"country"</span>, <span class="st">"year"</span>, <span class="st">"reporting_level"</span><span class="op">)</span>,</span>
<span>  parents <span class="op">=</span> <span class="va">parents2</span>,</span>
<span>  domain <span class="op">=</span> <span class="st">"summary"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Loaded [<span style="color: #00BB00;">qs2</span>] ← <span style="color: #0000BB;">/tmp/RtmpSn2PpI/s/data/welfare/ARG_2015.qs2</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Loaded [<span style="color: #00BB00;">qs2</span>] ← <span style="color: #0000BB;">/tmp/RtmpSn2PpI/s/data/welfare/COL_2010.qs2</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Loaded [<span style="color: #00BB00;">qs2</span>] ← <span style="color: #0000BB;">/tmp/RtmpSn2PpI/s/data/welfare/COL_2012.qs2</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Loaded [<span style="color: #00BB00;">qs2</span>] ← <span style="color: #0000BB;">/tmp/RtmpSn2PpI/s/data/welfare/MEX_2010.qs2</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Loaded [<span style="color: #00BB00;">qs2</span>] ← <span style="color: #0000BB;">/tmp/RtmpSn2PpI/s/data/welfare/MEX_2015.qs2</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Loaded [<span style="color: #00BB00;">qs2</span>] ← <span style="color: #0000BB;">/tmp/RtmpSn2PpI/s/data/welfare/PRY_2011.qs2</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Loaded [<span style="color: #00BB00;">qs2</span>] ← <span style="color: #0000BB;">/tmp/RtmpSn2PpI/s/data/welfare/PRY_2014.qs2</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Loaded [<span style="color: #00BB00;">qs2</span>] ← <span style="color: #0000BB;">/tmp/RtmpSn2PpI/s/data/macro/cpi.qs2</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Loaded [<span style="color: #00BB00;">qs2</span>] ← <span style="color: #0000BB;">/tmp/RtmpSn2PpI/s/data/macro/gdp.qs2</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Loaded [<span style="color: #00BB00;">qs2</span>] ← <span style="color: #0000BB;">/tmp/RtmpSn2PpI/s/data/macro/population.qs2</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Saved [<span style="color: #00BB00;">qs2</span>] → <span style="color: #0000BB;">/tmp/RtmpSn2PpI/s/outputs/welfare_summary.qs2</span> @ version</span></span>
<span><span class="co">#&gt;   <span style="color: #00BB00;">381caa9fa29d3e6d</span></span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="../reference/st_load.html">st_load</a></span><span class="op">(</span><span class="va">out_summary_path</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Loaded [<span style="color: #00BB00;">qs2</span>] ←</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">/tmp/RtmpSn2PpI/s/outputs/welfare_summary.qs2</span></span></span>
<span><span class="co">#&gt;    country  year reporting_level welfare_mean welfare_median welfare_sd</span></span>
<span><span class="co">#&gt;     &lt;char&gt; &lt;int&gt;          &lt;char&gt;        &lt;num&gt;          &lt;num&gt;      &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:     ARG  2015        national     3.100148          2.510   1.700340</span></span>
<span><span class="co">#&gt; 2:     COL  2010           rural     3.188479          2.895   1.604006</span></span>
<span><span class="co">#&gt; 3:     COL  2010           urban     3.065242          2.665   1.681036</span></span>
<span><span class="co">#&gt; 4:     COL  2012           rural     3.196254          2.820   1.872963</span></span>
<span><span class="co">#&gt; 5:     COL  2012           urban     3.079524          2.750   1.627238</span></span>
<span><span class="co">#&gt; 6:     MEX  2010           rural     3.247370          2.775   1.696690</span></span>
<span><span class="co">#&gt;    welfare_n      cpi          gdp population</span></span>
<span><span class="co">#&gt;        &lt;int&gt;    &lt;num&gt;        &lt;num&gt;      &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:       200 120.4800 250154797653    8785981</span></span>
<span><span class="co">#&gt; 2:       200  92.7100 449669674645   10746038</span></span>
<span><span class="co">#&gt; 3:       200  99.1000 449669674645    5152778</span></span>
<span><span class="co">#&gt; 4:       200  97.7655  55701684731    7761159</span></span>
<span><span class="co">#&gt; 5:       200 116.9910  55701684731   15249755</span></span>
<span><span class="co">#&gt; 6:       200  93.6800 384563952393    5367608</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="partitioned-workflow-for-partial-re-execution">6. Partitioned Workflow for Partial Re-execution<a class="anchor" aria-label="anchor" href="#partitioned-workflow-for-partial-re-execution"></a>
</h3>
<p>Instead of storing one large welfare micro file per country-year, we
can store partitions per <code>(country, year, reporting_level)</code>
using <code><a href="../reference/st_save_part.html">st_save_part()</a></code> and then recompute only the affected
partitions when an input changes.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/create.html" class="external-link">dir_create</a></span><span class="op">(</span><span class="va">welfare_parts_dir</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Write partitioned welfare (one partition per country/year/reporting_level)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">welfare_specs</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">row</span> <span class="op">&lt;-</span> <span class="va">welfare_specs</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span></span>
<span>  <span class="va">dt</span> <span class="op">&lt;-</span> <span class="fu">simulate_welfare</span><span class="op">(</span><span class="va">row</span><span class="op">$</span><span class="va">country</span>, <span class="va">row</span><span class="op">$</span><span class="va">year</span><span class="op">)</span> <span class="co"># new simulated (independent from earlier saves)</span></span>
<span>  <span class="co"># split by reporting_level</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">rl</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">dt</span><span class="op">$</span><span class="va">reporting_level</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">part_dt</span> <span class="op">&lt;-</span> <span class="va">dt</span><span class="op">[</span><span class="va">reporting_level</span> <span class="op">==</span> <span class="va">rl</span><span class="op">]</span></span>
<span>    <span class="fu"><a href="../reference/st_save_part.html">st_save_part</a></span><span class="op">(</span></span>
<span>      <span class="va">part_dt</span>,</span>
<span>      base <span class="op">=</span> <span class="va">welfare_parts_dir</span>,</span>
<span>      key <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>country <span class="op">=</span> <span class="va">row</span><span class="op">$</span><span class="va">country</span>, year <span class="op">=</span> <span class="va">row</span><span class="op">$</span><span class="va">year</span>, reporting_level <span class="op">=</span> <span class="va">rl</span><span class="op">)</span>,</span>
<span>      code_label <span class="op">=</span> <span class="st">"welfare_partition"</span>,</span>
<span>      pk <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"country"</span>, <span class="st">"year"</span>, <span class="st">"reporting_level"</span>, <span class="st">"hh_id"</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Saved [<span style="color: #00BB00;">qs2</span>] →</span></span>
<span><span class="co">#&gt;   <span style="color: #0000BB;">/tmp/RtmpSn2PpI/s/data/welfare_parts/country=COL/reporting_level=urban/year=2010/part.qs2</span></span></span>
<span><span class="co">#&gt;   @ version <span style="color: #00BB00;">f6448f219d342016</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Saved [<span style="color: #00BB00;">qs2</span>] →</span></span>
<span><span class="co">#&gt;   <span style="color: #0000BB;">/tmp/RtmpSn2PpI/s/data/welfare_parts/country=COL/reporting_level=rural/year=2010/part.qs2</span></span></span>
<span><span class="co">#&gt;   @ version <span style="color: #00BB00;">959de31c2d1ffed4</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Saved [<span style="color: #00BB00;">qs2</span>] →</span></span>
<span><span class="co">#&gt;   <span style="color: #0000BB;">/tmp/RtmpSn2PpI/s/data/welfare_parts/country=COL/reporting_level=urban/year=2012/part.qs2</span></span></span>
<span><span class="co">#&gt;   @ version <span style="color: #00BB00;">38961d4886c4775f</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Saved [<span style="color: #00BB00;">qs2</span>] →</span></span>
<span><span class="co">#&gt;   <span style="color: #0000BB;">/tmp/RtmpSn2PpI/s/data/welfare_parts/country=COL/reporting_level=rural/year=2012/part.qs2</span></span></span>
<span><span class="co">#&gt;   @ version <span style="color: #00BB00;">5ad9186f14978b81</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Saved [<span style="color: #00BB00;">qs2</span>] →</span></span>
<span><span class="co">#&gt;   <span style="color: #0000BB;">/tmp/RtmpSn2PpI/s/data/welfare_parts/country=MEX/reporting_level=urban/year=2010/part.qs2</span></span></span>
<span><span class="co">#&gt;   @ version <span style="color: #00BB00;">a036807dece25bc1</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Saved [<span style="color: #00BB00;">qs2</span>] →</span></span>
<span><span class="co">#&gt;   <span style="color: #0000BB;">/tmp/RtmpSn2PpI/s/data/welfare_parts/country=MEX/reporting_level=rural/year=2010/part.qs2</span></span></span>
<span><span class="co">#&gt;   @ version <span style="color: #00BB00;">14fb0c42cd5bf727</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Saved [<span style="color: #00BB00;">qs2</span>] →</span></span>
<span><span class="co">#&gt;   <span style="color: #0000BB;">/tmp/RtmpSn2PpI/s/data/welfare_parts/country=MEX/reporting_level=urban/year=2015/part.qs2</span></span></span>
<span><span class="co">#&gt;   @ version <span style="color: #00BB00;">71f9821a8de8897e</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Saved [<span style="color: #00BB00;">qs2</span>] →</span></span>
<span><span class="co">#&gt;   <span style="color: #0000BB;">/tmp/RtmpSn2PpI/s/data/welfare_parts/country=MEX/reporting_level=rural/year=2015/part.qs2</span></span></span>
<span><span class="co">#&gt;   @ version <span style="color: #00BB00;">05684c727b922034</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Saved [<span style="color: #00BB00;">qs2</span>] →</span></span>
<span><span class="co">#&gt;   <span style="color: #0000BB;">/tmp/RtmpSn2PpI/s/data/welfare_parts/country=PRY/reporting_level=national/year=2011/part.qs2</span></span></span>
<span><span class="co">#&gt;   @ version <span style="color: #00BB00;">a8972c58d02ab0cf</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Saved [<span style="color: #00BB00;">qs2</span>] →</span></span>
<span><span class="co">#&gt;   <span style="color: #0000BB;">/tmp/RtmpSn2PpI/s/data/welfare_parts/country=PRY/reporting_level=national/year=2014/part.qs2</span></span></span>
<span><span class="co">#&gt;   @ version <span style="color: #00BB00;">b1b9a669afaa2f3c</span></span></span>
<span><span class="fu"><a href="../reference/st_list_parts.html">st_list_parts</a></span><span class="op">(</span><span class="va">welfare_parts_dir</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">6</span>, <span class="op">]</span></span>
<span><span class="co">#&gt;                                                                                        path</span></span>
<span><span class="co">#&gt; 1 /tmp/RtmpSn2PpI/s/data/welfare_parts/country=COL/reporting_level=rural/year=2010/part.qs2</span></span>
<span><span class="co">#&gt; 2 /tmp/RtmpSn2PpI/s/data/welfare_parts/country=COL/reporting_level=rural/year=2012/part.qs2</span></span>
<span><span class="co">#&gt; 3 /tmp/RtmpSn2PpI/s/data/welfare_parts/country=COL/reporting_level=urban/year=2010/part.qs2</span></span>
<span><span class="co">#&gt; 4 /tmp/RtmpSn2PpI/s/data/welfare_parts/country=COL/reporting_level=urban/year=2012/part.qs2</span></span>
<span><span class="co">#&gt; 5 /tmp/RtmpSn2PpI/s/data/welfare_parts/country=MEX/reporting_level=rural/year=2010/part.qs2</span></span>
<span><span class="co">#&gt; 6 /tmp/RtmpSn2PpI/s/data/welfare_parts/country=MEX/reporting_level=rural/year=2015/part.qs2</span></span>
<span><span class="co">#&gt;   country reporting_level year</span></span>
<span><span class="co">#&gt; 1     COL           rural 2010</span></span>
<span><span class="co">#&gt; 2     COL           rural 2012</span></span>
<span><span class="co">#&gt; 3     COL           urban 2010</span></span>
<span><span class="co">#&gt; 4     COL           urban 2012</span></span>
<span><span class="co">#&gt; 5     MEX           rural 2010</span></span>
<span><span class="co">#&gt; 6     MEX           rural 2015</span></span></code></pre></div>
<p>Define a partitioned builder writing one output partition per
<code>(country, year, reporting_level)</code> summary row. Each output
partition depends on: the corresponding welfare partition + CPI + GDP +
population (all three macro artifacts are shared parents).</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/create.html" class="external-link">dir_create</a></span><span class="op">(</span><span class="va">summary_parts_dir</span><span class="op">)</span></span>
<span></span>
<span><span class="va">partition_keys</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/st_list_parts.html">st_list_parts</a></span><span class="op">(</span><span class="va">welfare_parts_dir</span><span class="op">)</span></span>
<span></span>
<span><span class="va">build_partition_summary</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">path</span>, <span class="va">parents</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># path is the final destination for this partition artifact</span></span>
<span>  <span class="co"># Extract key by parsing path (we stored key in directory names)</span></span>
<span>  <span class="va">rel</span> <span class="op">&lt;-</span> <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path_math.html" class="external-link">path_rel</a></span><span class="op">(</span><span class="va">path</span>, start <span class="op">=</span> <span class="va">summary_parts_dir</span><span class="op">)</span></span>
<span>  <span class="va">segs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/strsplit.html" class="external-link">strsplit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/basename.html" class="external-link">dirname</a></span><span class="op">(</span><span class="va">rel</span><span class="op">)</span>, <span class="va">.Platform</span><span class="op">$</span><span class="va">file.sep</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="va">segs</span> <span class="op">&lt;-</span> <span class="va">segs</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/nchar.html" class="external-link">nzchar</a></span><span class="op">(</span><span class="va">segs</span><span class="op">)</span><span class="op">]</span></span>
<span>  <span class="co"># Extract only segments that follow the key=value pattern and ignore others</span></span>
<span>  <span class="va">kv_pairs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">segs</span>, <span class="kw">function</span><span class="op">(</span><span class="va">s</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/regmatches.html" class="external-link">regmatches</a></span><span class="op">(</span><span class="va">s</span>, <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">regexec</a></span><span class="op">(</span><span class="st">"^([^=]+)=(.*)$"</span>, <span class="va">s</span><span class="op">)</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span> <span class="op">==</span> <span class="fl">3L</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>k <span class="op">=</span> <span class="va">m</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, v <span class="op">=</span> <span class="va">m</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span> <span class="kw">else</span> <span class="cn">NULL</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  <span class="va">kv_pairs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/funprog.html" class="external-link">Filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/funprog.html" class="external-link">Negate</a></span><span class="op">(</span><span class="va">is.null</span><span class="op">)</span>, <span class="va">kv_pairs</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">kv_pairs</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">key</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="va">key</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">kv_pairs</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="va">v</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">vapply</a></span><span class="op">(</span><span class="va">kv_pairs</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="va">k</span>, <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">character</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># Load welfare partition matching key</span></span>
<span>  <span class="va">w_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/st_part_path.html">st_part_path</a></span><span class="op">(</span><span class="va">welfare_parts_dir</span>, <span class="va">key</span>, format <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span>
<span>  <span class="va">w</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/st_load.html">st_load</a></span><span class="op">(</span><span class="va">w_path</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">stats</span> <span class="op">&lt;-</span> <span class="va">w</span><span class="op">[</span>,</span>
<span>    <span class="fu">.</span><span class="op">(</span></span>
<span>      welfare_mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/weighted.mean.html" class="external-link">weighted.mean</a></span><span class="op">(</span><span class="va">welfare</span>, <span class="va">weight</span><span class="op">)</span>,</span>
<span>      welfare_median <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">welfare</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      welfare_sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">welfare</span><span class="op">)</span>,</span>
<span>      welfare_n <span class="op">=</span> <span class="va">.N</span></span>
<span>    <span class="op">)</span>,</span>
<span>    by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">country</span>, <span class="va">year</span>, <span class="va">reporting_level</span><span class="op">)</span></span>
<span>  <span class="op">]</span></span>
<span></span>
<span>  <span class="co"># Load macro (shared) and subset to key</span></span>
<span>  <span class="va">cpi</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/st_load.html">st_load</a></span><span class="op">(</span><span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path.html" class="external-link">path</a></span><span class="op">(</span><span class="va">macro_dir</span>, <span class="st">"cpi.qs2"</span><span class="op">)</span><span class="op">)</span><span class="op">[</span></span>
<span>    <span class="va">country</span> <span class="op">==</span> <span class="va">key</span><span class="op">$</span><span class="va">country</span> <span class="op">&amp;</span></span>
<span>      <span class="va">year</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">key</span><span class="op">$</span><span class="va">year</span><span class="op">)</span> <span class="op">&amp;</span></span>
<span>      <span class="va">reporting_level</span> <span class="op">==</span> <span class="va">key</span><span class="op">$</span><span class="va">reporting_level</span></span>
<span>  <span class="op">]</span></span>
<span>  <span class="va">pop</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/st_load.html">st_load</a></span><span class="op">(</span><span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path.html" class="external-link">path</a></span><span class="op">(</span><span class="va">macro_dir</span>, <span class="st">"population.qs2"</span><span class="op">)</span><span class="op">)</span><span class="op">[</span></span>
<span>    <span class="va">country</span> <span class="op">==</span> <span class="va">key</span><span class="op">$</span><span class="va">country</span> <span class="op">&amp;</span></span>
<span>      <span class="va">year</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">key</span><span class="op">$</span><span class="va">year</span><span class="op">)</span> <span class="op">&amp;</span></span>
<span>      <span class="va">reporting_level</span> <span class="op">==</span> <span class="va">key</span><span class="op">$</span><span class="va">reporting_level</span></span>
<span>  <span class="op">]</span></span>
<span>  <span class="va">gdp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/st_load.html">st_load</a></span><span class="op">(</span><span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path.html" class="external-link">path</a></span><span class="op">(</span><span class="va">macro_dir</span>, <span class="st">"gdp.qs2"</span><span class="op">)</span><span class="op">)</span><span class="op">[</span></span>
<span>    <span class="va">country</span> <span class="op">==</span> <span class="va">key</span><span class="op">$</span><span class="va">country</span> <span class="op">&amp;</span> <span class="va">year</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">key</span><span class="op">$</span><span class="va">year</span><span class="op">)</span></span>
<span>  <span class="op">]</span></span>
<span></span>
<span>  <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html" class="external-link">merge</a></span><span class="op">(</span></span>
<span>    <span class="va">stats</span>,</span>
<span>    <span class="va">cpi</span>,</span>
<span>    by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"country"</span>, <span class="st">"year"</span>, <span class="st">"reporting_level"</span><span class="op">)</span>,</span>
<span>    all.x <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html" class="external-link">merge</a></span><span class="op">(</span></span>
<span>    <span class="va">out</span>,</span>
<span>    <span class="va">pop</span>,</span>
<span>    by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"country"</span>, <span class="st">"year"</span>, <span class="st">"reporting_level"</span><span class="op">)</span>,</span>
<span>    all.x <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html" class="external-link">merge</a></span><span class="op">(</span><span class="va">out</span>, <span class="va">gdp</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"country"</span>, <span class="st">"year"</span><span class="op">)</span>, all.x <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="va">out</span>,</span>
<span>    code <span class="op">=</span> <span class="va">build_partition_summary</span>,</span>
<span>    code_label <span class="op">=</span> <span class="st">"partition_summary"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># List a few partitioned summary partitions</span></span>
<span><span class="fu"><a href="../reference/st_list_parts.html">st_list_parts</a></span><span class="op">(</span><span class="va">summary_parts_dir</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">6</span>, <span class="op">]</span></span>
<span><span class="co">#&gt; [1] NA NA NA NA NA NA</span></span></code></pre></div>
<div class="section level4">
<h4 id="partial-re-execution-after-cpi-change">Partial Re-execution After CPI Change<a class="anchor" aria-label="anchor" href="#partial-re-execution-after-cpi-change"></a>
</h4>
<p>If CPI changes only for COL 2012, we want to rebuild only partitions
for COL 2012 across reporting levels.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Modify CPI again (COL 2012) to trigger staleness</span></span>
<span><span class="va">cpi3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/st_load.html">st_load</a></span><span class="op">(</span><span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path.html" class="external-link">path</a></span><span class="op">(</span><span class="va">macro_dir</span>, <span class="st">"cpi.qs2"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Loaded [<span style="color: #00BB00;">qs2</span>] ←</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">/tmp/RtmpSn2PpI/s/data/macro/cpi.qs2</span></span></span>
<span><span class="va">cpi3</span><span class="op">[</span><span class="va">country</span> <span class="op">==</span> <span class="st">"COL"</span> <span class="op">&amp;</span> <span class="va">year</span> <span class="op">==</span> <span class="fl">2012</span>, <span class="va">cpi</span> <span class="op">:=</span> <span class="va">cpi</span> <span class="op">*</span> <span class="fl">1.02</span><span class="op">]</span></span>
<span><span class="fu"><a href="../reference/st_save.html">st_save</a></span><span class="op">(</span><span class="va">cpi3</span>, <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path.html" class="external-link">path</a></span><span class="op">(</span><span class="va">macro_dir</span>, <span class="st">"cpi.qs2"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Saved [<span style="color: #00BB00;">qs2</span>] →</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">/tmp/RtmpSn2PpI/s/data/macro/cpi.qs2</span> @ version <span style="color: #00BB00;">d1ff1c23e994508e</span></span></span>
<span></span>
<span><span class="co"># Detect which partition outputs are stale (simple check: those whose parent CPI version differs)</span></span>
<span><span class="va">summary_parts</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/st_list_parts.html">st_list_parts</a></span><span class="op">(</span><span class="va">summary_parts_dir</span><span class="op">)</span></span>
<span><span class="va">stale_idx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">vapply</a></span><span class="op">(</span><span class="va">summary_parts</span><span class="op">$</span><span class="va">path</span>, <span class="va">st_is_stale</span>, <span class="fu"><a href="https://rdrr.io/r/base/logical.html" class="external-link">logical</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">summary_parts</span><span class="op">[</span><span class="va">stale_idx</span>, <span class="op">]</span></span>
<span><span class="co">#&gt; character(0)</span></span></code></pre></div>
<p>Rebuild only stale partitions (manually filtered):</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">stale_paths</span> <span class="op">&lt;-</span> <span class="va">summary_parts</span><span class="op">$</span><span class="va">path</span><span class="op">[</span><span class="va">stale_idx</span><span class="op">]</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">p</span> <span class="kw">in</span> <span class="va">stale_paths</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># reconstruct key from path to identify its welfare partition parent</span></span>
<span>  <span class="va">rel</span> <span class="op">&lt;-</span> <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path_math.html" class="external-link">path_rel</a></span><span class="op">(</span><span class="va">p</span>, start <span class="op">=</span> <span class="va">summary_parts_dir</span><span class="op">)</span></span>
<span>  <span class="va">segs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/strsplit.html" class="external-link">strsplit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/basename.html" class="external-link">dirname</a></span><span class="op">(</span><span class="va">rel</span><span class="op">)</span>, <span class="va">.Platform</span><span class="op">$</span><span class="va">file.sep</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="va">kv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">segs</span>, <span class="kw">function</span><span class="op">(</span><span class="va">s</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/strsplit.html" class="external-link">strsplit</a></span><span class="op">(</span><span class="va">s</span>, <span class="st">"="</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">key</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">kv</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">kv</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">parents</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      path <span class="op">=</span> <span class="fu"><a href="../reference/st_part_path.html">st_part_path</a></span><span class="op">(</span><span class="va">welfare_parts_dir</span>, <span class="va">key</span><span class="op">)</span>,</span>
<span>      version_id <span class="op">=</span> <span class="fu"><a href="../reference/st_latest.html">st_latest</a></span><span class="op">(</span><span class="fu"><a href="../reference/st_part_path.html">st_part_path</a></span><span class="op">(</span><span class="va">welfare_parts_dir</span>, <span class="va">key</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      path <span class="op">=</span> <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path.html" class="external-link">path</a></span><span class="op">(</span><span class="va">macro_dir</span>, <span class="st">"cpi.qs2"</span><span class="op">)</span>,</span>
<span>      version_id <span class="op">=</span> <span class="fu"><a href="../reference/st_latest.html">st_latest</a></span><span class="op">(</span><span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path.html" class="external-link">path</a></span><span class="op">(</span><span class="va">macro_dir</span>, <span class="st">"cpi.qs2"</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      path <span class="op">=</span> <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path.html" class="external-link">path</a></span><span class="op">(</span><span class="va">macro_dir</span>, <span class="st">"gdp.qs2"</span><span class="op">)</span>,</span>
<span>      version_id <span class="op">=</span> <span class="fu"><a href="../reference/st_latest.html">st_latest</a></span><span class="op">(</span><span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path.html" class="external-link">path</a></span><span class="op">(</span><span class="va">macro_dir</span>, <span class="st">"gdp.qs2"</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      path <span class="op">=</span> <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path.html" class="external-link">path</a></span><span class="op">(</span><span class="va">macro_dir</span>, <span class="st">"population.qs2"</span><span class="op">)</span>,</span>
<span>      version_id <span class="op">=</span> <span class="fu"><a href="../reference/st_latest.html">st_latest</a></span><span class="op">(</span><span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path.html" class="external-link">path</a></span><span class="op">(</span><span class="va">macro_dir</span>, <span class="st">"population.qs2"</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="va">b</span> <span class="op">&lt;-</span> <span class="fu">build_partition_summary</span><span class="op">(</span><span class="va">p</span>, <span class="va">parents</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/st_save.html">st_save</a></span><span class="op">(</span></span>
<span>    <span class="va">b</span><span class="op">$</span><span class="va">x</span>,</span>
<span>    <span class="va">p</span>,</span>
<span>    parents <span class="op">=</span> <span class="va">parents</span>,</span>
<span>    pk <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"country"</span>, <span class="st">"year"</span>, <span class="st">"reporting_level"</span><span class="op">)</span>,</span>
<span>    code <span class="op">=</span> <span class="va">b</span><span class="op">$</span><span class="va">code</span>,</span>
<span>    code_label <span class="op">=</span> <span class="va">b</span><span class="op">$</span><span class="va">code_label</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Only COL 2012 partitions were recomputed, avoiding unnecessary work
for other countries/years.</p>
</div>
</div>
<div class="section level3">
<h3 id="summary">7. Summary<a class="anchor" aria-label="anchor" href="#summary"></a>
</h3>
<p>We demonstrated:</p>
<ul>
<li>Saving multiple artifacts with PK metadata and automatic
versioning.</li>
<li>Building a derived summary with explicit lineage and rebuilding
after an upstream change.</li>
<li>Adding new data (ARG 2015) and incorporating it with minimal
friction.</li>
<li>A partitioned strategy enabling targeted re-execution for changed
inputs.</li>
</ul>
<p>Explore lineage further:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/st_lineage.html">st_lineage</a></span><span class="op">(</span><span class="va">out_summary_path</span>, depth <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, <span class="op">]</span></span>
<span><span class="co">#&gt;    level                                    child_path    child_version</span></span>
<span><span class="co">#&gt; 1      1 /tmp/RtmpSn2PpI/s/outputs/welfare_summary.qs2 381caa9fa29d3e6d</span></span>
<span><span class="co">#&gt; 2      1 /tmp/RtmpSn2PpI/s/outputs/welfare_summary.qs2 381caa9fa29d3e6d</span></span>
<span><span class="co">#&gt; 3      1 /tmp/RtmpSn2PpI/s/outputs/welfare_summary.qs2 381caa9fa29d3e6d</span></span>
<span><span class="co">#&gt; 4      1 /tmp/RtmpSn2PpI/s/outputs/welfare_summary.qs2 381caa9fa29d3e6d</span></span>
<span><span class="co">#&gt; 5      1 /tmp/RtmpSn2PpI/s/outputs/welfare_summary.qs2 381caa9fa29d3e6d</span></span>
<span><span class="co">#&gt; 6      1 /tmp/RtmpSn2PpI/s/outputs/welfare_summary.qs2 381caa9fa29d3e6d</span></span>
<span><span class="co">#&gt; 7      1 /tmp/RtmpSn2PpI/s/outputs/welfare_summary.qs2 381caa9fa29d3e6d</span></span>
<span><span class="co">#&gt; 8      1 /tmp/RtmpSn2PpI/s/outputs/welfare_summary.qs2 381caa9fa29d3e6d</span></span>
<span><span class="co">#&gt; 9      1 /tmp/RtmpSn2PpI/s/outputs/welfare_summary.qs2 381caa9fa29d3e6d</span></span>
<span><span class="co">#&gt; 10     1 /tmp/RtmpSn2PpI/s/outputs/welfare_summary.qs2 381caa9fa29d3e6d</span></span>
<span><span class="co">#&gt;                                    parent_path   parent_version</span></span>
<span><span class="co">#&gt; 1  /tmp/RtmpSn2PpI/s/data/welfare/ARG_2015.qs2 16a8fd2c4d6bf395</span></span>
<span><span class="co">#&gt; 2  /tmp/RtmpSn2PpI/s/data/welfare/COL_2010.qs2 75ad53d22bdc889c</span></span>
<span><span class="co">#&gt; 3  /tmp/RtmpSn2PpI/s/data/welfare/COL_2012.qs2 22a631e9cf4b654b</span></span>
<span><span class="co">#&gt; 4  /tmp/RtmpSn2PpI/s/data/welfare/MEX_2010.qs2 8cd1d3757fd8861e</span></span>
<span><span class="co">#&gt; 5  /tmp/RtmpSn2PpI/s/data/welfare/MEX_2015.qs2 5ae25a0f064c4022</span></span>
<span><span class="co">#&gt; 6  /tmp/RtmpSn2PpI/s/data/welfare/PRY_2011.qs2 1661f2a8e0925673</span></span>
<span><span class="co">#&gt; 7  /tmp/RtmpSn2PpI/s/data/welfare/PRY_2014.qs2 8515270d66067cfc</span></span>
<span><span class="co">#&gt; 8         /tmp/RtmpSn2PpI/s/data/macro/cpi.qs2 7d301454602ecbd6</span></span>
<span><span class="co">#&gt; 9         /tmp/RtmpSn2PpI/s/data/macro/gdp.qs2 0f3eb09ce38cedc6</span></span>
<span><span class="co">#&gt; 10 /tmp/RtmpSn2PpI/s/data/macro/population.qs2 5c212fac3a83dc1f</span></span></code></pre></div>
<warning><strong>Warning: The code below will permanently delete the temporary
vignette root directory and all its contents.</strong>
</warning><div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Remove the temporary root used for vignette examples. Only run in a local</span></span>
<span><span class="co"># interactive session when you are sure you no longer need the temporary files.</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/exists.html" class="external-link">exists</a></span><span class="op">(</span><span class="st">"root_dir"</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/file_access.html" class="external-link">dir_exists</a></span><span class="op">(</span><span class="va">root_dir</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># fs::dir_delete() permanently removes the directory tree.</span></span>
<span>  <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/delete.html" class="external-link">dir_delete</a></span><span class="op">(</span><span class="va">root_dir</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by R.Andres Castaneda, Diana C. Garcia Rojas.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
