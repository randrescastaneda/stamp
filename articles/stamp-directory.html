<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>The .stamp Directory: Structure and Internals • stamp</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="The .stamp Directory: Structure and Internals">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">stamp</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">0.0.7</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/stamp.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Basics</h6></li>
    <li><a class="dropdown-item" href="../articles/setup-and-basics.html">Setup and Basics</a></li>
    <li><a class="dropdown-item" href="../articles/stamp-directory.html">The .stamp Directory: Structure and Internals</a></li>
    <li><a class="dropdown-item" href="../articles/hashing-and-versions.html">Hashing, Change Detection and Versions</a></li>
    <li><a class="dropdown-item" href="../articles/lineage-rebuilds.html">Lineage and Rebuilds</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Advanced Usage</h6></li>
    <li><a class="dropdown-item" href="../articles/builders-plans.html">Builders, Plans, and Rebuilds</a></li>
    <li><a class="dropdown-item" href="../articles/version_retention_prune.html">Version Retention, Pruning, and Table Metadata</a></li>
    <li><a class="dropdown-item" href="../articles/partitions.html">Working with Partitioned Datasets</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/randrescastaneda/stamp"><span class="fa fa-github"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>The .stamp Directory: Structure and Internals</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/randrescastaneda/stamp/blob/master/vignettes/stamp-directory.Rmd" class="external-link"><code>vignettes/stamp-directory.Rmd</code></a></small>
      <div class="d-none name"><code>stamp-directory.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<p>The <code>.stamp/</code> directory is the <strong>persistent storage
backend</strong> for the <code>stamp</code> package’s versioning system.
This vignette explains:</p>
<ol style="list-style-type: decimal">
<li>How and when <code>.stamp/</code> is created</li>
<li>Its internal directory structure</li>
<li>How versioning and metadata work under the hood</li>
<li>Troubleshooting common issues</li>
</ol>
<p><strong>Audience:</strong> This vignette serves both
<strong>users</strong> (understanding what <code>.stamp</code> does) and
<strong>developers</strong> (understanding internal implementation
details).</p>
<hr>
</div>
<div class="section level2">
<h2 id="creation-and-initialization">1. Creation and Initialization<a class="anchor" aria-label="anchor" href="#creation-and-initialization"></a>
</h2>
<div class="section level3">
<h3 id="creating--stamp-with-st_init">1.1 Creating <code>.stamp/</code> with <code>st_init()</code><a class="anchor" aria-label="anchor" href="#creating--stamp-with-st_init"></a>
</h3>
<p>The <code>.stamp/</code> directory is created when you call
<code><a href="../reference/st_init.html">st_init()</a></code>:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create a temporary project directory for demonstration</span></span>
<span><span class="va">demo_dir</span> <span class="op">&lt;-</span> <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/file_temp.html" class="external-link">path_temp</a></span><span class="op">(</span><span class="st">"stamp-demo"</span><span class="op">)</span></span>
<span><span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/create.html" class="external-link">dir_create</a></span><span class="op">(</span><span class="va">demo_dir</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Initialize stamp</span></span>
<span><span class="fu"><a href="../reference/st_init.html">st_init</a></span><span class="op">(</span><span class="va">demo_dir</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> stamp initialized</span></span>
<span><span class="co">#&gt;   root: /tmp/RtmpMf7Yu1/stamp-demo</span></span>
<span><span class="co">#&gt;   state: /tmp/RtmpMf7Yu1/stamp-demo/.stamp</span></span>
<span></span>
<span><span class="co"># Inspect what was created</span></span>
<span><span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/dir_tree.html" class="external-link">dir_tree</a></span><span class="op">(</span><span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path.html" class="external-link">path</a></span><span class="op">(</span><span class="va">demo_dir</span>, <span class="st">".stamp"</span><span class="op">)</span>, recurse <span class="op">=</span> <span class="cn">TRUE</span>, all <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB; font-weight: bold;">/tmp/RtmpMf7Yu1/stamp-demo/.stamp</span></span></span>
<span><span class="co">#&gt; ├── <span style="color: #0000BB; font-weight: bold;">logs</span></span></span>
<span><span class="co">#&gt; └── <span style="color: #0000BB; font-weight: bold;">temp</span></span></span></code></pre></div>
<p><strong>What happens during initialization:</strong></p>
<ol style="list-style-type: decimal">
<li>
<p><strong>Creates directory structure</strong> (if it doesn’t
exist):</p>
<ul>
<li>
<code>.stamp/</code> - Root state directory</li>
<li>
<code>.stamp/temp/</code> - Temporary files during atomic
writes</li>
<li>
<code>.stamp/logs/</code> - Future use for logging (currently
unused)</li>
</ul>
</li>
<li><p><strong>Records project root</strong> in package state (in-memory
reference)</p></li>
<li><p><strong>Does NOT create or initialize</strong> the catalog yet -
that happens on first save</p></li>
</ol>
</div>
<div class="section level3">
<h3 id="re-running-st_init-safe-and-non-destructive">1.2 Re-running <code>st_init()</code>: Safe and Non-Destructive<a class="anchor" aria-label="anchor" href="#re-running-st_init-safe-and-non-destructive"></a>
</h3>
<p><strong>Important:</strong> Running <code><a href="../reference/st_init.html">st_init()</a></code> multiple
times is <strong>safe</strong> and will <strong>NOT</strong> delete or
overwrite existing version history.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Save an artifact to create version history</span></span>
<span><span class="va">test_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, y <span class="op">=</span> <span class="va">letters</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">test_path</span> <span class="op">&lt;-</span> <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path.html" class="external-link">path</a></span><span class="op">(</span><span class="va">demo_dir</span>, <span class="st">"data"</span>, <span class="st">"test.qs2"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/st_save.html">st_save</a></span><span class="op">(</span><span class="va">test_data</span>, <span class="va">test_path</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Saved [<span style="color: #00BB00;">qs2</span>] → <span style="color: #0000BB;">/tmp/RtmpMf7Yu1/stamp-demo/data/test.qs2</span> @ version</span></span>
<span><span class="co">#&gt;   <span style="color: #00BB00;">1b5b0bd1fc1a260f</span></span></span>
<span></span>
<span><span class="co"># Check versions exist</span></span>
<span><span class="va">versions_before</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/st_versions.html">st_versions</a></span><span class="op">(</span><span class="va">test_path</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">versions_before</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1</span></span>
<span></span>
<span><span class="co"># Re-initialize (this is safe!)</span></span>
<span><span class="fu"><a href="../reference/st_init.html">st_init</a></span><span class="op">(</span><span class="va">demo_dir</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> stamp initialized</span></span>
<span><span class="co">#&gt;   root: /tmp/RtmpMf7Yu1/stamp-demo</span></span>
<span><span class="co">#&gt;   state: /tmp/RtmpMf7Yu1/stamp-demo/.stamp</span></span>
<span></span>
<span><span class="co"># Version history is preserved</span></span>
<span><span class="va">versions_after</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/st_versions.html">st_versions</a></span><span class="op">(</span><span class="va">test_path</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="va">versions_before</span>, <span class="va">versions_after</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
<p><strong>Why is this safe?</strong></p>
<ul>
<li>
<code><a href="../reference/st_init.html">st_init()</a></code> only creates directories that don’t
exist</li>
<li>The catalog file (<code>catalog.qs2</code>) is read if present,
never deleted</li>
<li>Version snapshots in <code>versions/</code> are never touched by
initialization</li>
</ul>
<hr>
</div>
</div>
<div class="section level2">
<h2 id="directory-structure-explained">2. Directory Structure Explained<a class="anchor" aria-label="anchor" href="#directory-structure-explained"></a>
</h2>
<div class="section level3">
<h3 id="high-level-layout">2.1 High-Level Layout<a class="anchor" aria-label="anchor" href="#high-level-layout"></a>
</h3>
<pre><code>.stamp/                          # Root state directory
├── catalog.qs2                  # Central version registry (created on first save)
├── catalog.lock                 # Lock file for concurrent access control
├── temp/                        # Temporary files during atomic writes
├── logs/                        # Reserved for future logging features
└── versions/                    # Version snapshots (created on first save)
    ├── data/                    # Mirrors your project structure
    │   └── test.qs2/            # One folder per artifact
    │       ├── 20250108T121500Z-abc12345/   # Version snapshot directory
    │       │   ├── artifact                  # Snapshot of the file itself
    │       │   ├── sidecar.json              # Metadata at save time
    │       │   ├── sidecar.qs2               # (optional) Binary metadata
    │       │   └── parents.json              # Lineage information
    │       └── 20250108T143000Z-def67890/   # Another version
    │           └── ...
    └── external/                # Artifacts outside project root
        └── a1b2c3d4-external.csv/
            └── ...</code></pre>
<p>Let’s explore each component:</p>
</div>
<div class="section level3">
<h3 id="the-catalog-catalog-qs2">2.2 The Catalog: <code>catalog.qs2</code><a class="anchor" aria-label="anchor" href="#the-catalog-catalog-qs2"></a>
</h3>
<p>The catalog is a <strong>central registry</strong> tracking all
artifacts and their versions. It’s a QS2-serialized list containing two
<code>data.table</code> objects:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">catalog</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  artifacts <span class="op">=</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span></span>
<span>    <span class="va">artifact_id</span>,          <span class="co"># Stable hash of normalized path</span></span>
<span>    <span class="va">path</span>,                 <span class="co"># Current canonical path</span></span>
<span>    <span class="va">format</span>,               <span class="co"># File format (rds, qs2, csv, etc.)</span></span>
<span>    <span class="va">latest_version_id</span>,    <span class="co"># Most recent version identifier</span></span>
<span>    <span class="va">n_versions</span>            <span class="co"># Total number of saved versions</span></span>
<span>  <span class="op">)</span>,</span>
<span>  versions <span class="op">=</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span></span>
<span>    <span class="va">version_id</span>,           <span class="co"># Unique version identifier</span></span>
<span>    <span class="va">artifact_id</span>,          <span class="co"># Links to artifacts table</span></span>
<span>    <span class="va">content_hash</span>,         <span class="co"># Hash of file contents</span></span>
<span>    <span class="va">code_hash</span>,            <span class="co"># Hash of generating code (if tracked)</span></span>
<span>    <span class="va">size_bytes</span>,           <span class="co"># File size in bytes</span></span>
<span>    <span class="va">created_at</span>,           <span class="co"># ISO8601 UTC timestamp</span></span>
<span>    <span class="va">sidecar_format</span>        <span class="co"># "json", "qs2", "both", or "none"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><strong>Key functions that read the catalog:</strong></p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># List all versions of an artifact</span></span>
<span><span class="va">versions</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/st_versions.html">st_versions</a></span><span class="op">(</span><span class="va">test_path</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">versions</span><span class="op">)</span></span>
<span><span class="co">#&gt; Classes 'data.table' and 'data.frame':   1 obs. of  7 variables:</span></span>
<span><span class="co">#&gt;  $ version_id    : chr "1b5b0bd1fc1a260f"</span></span>
<span><span class="co">#&gt;  $ artifact_id   : chr "ca522ace929b250f"</span></span>
<span><span class="co">#&gt;  $ content_hash  : chr "2d26c6e5d9121bfd"</span></span>
<span><span class="co">#&gt;  $ code_hash     : chr NA</span></span>
<span><span class="co">#&gt;  $ size_bytes    : num 262</span></span>
<span><span class="co">#&gt;  $ created_at    : chr "2026-01-15T22:48:57.747827Z"</span></span>
<span><span class="co">#&gt;  $ sidecar_format: chr "json"</span></span>
<span><span class="co">#&gt;  - attr(*, ".internal.selfref")=&lt;externalptr&gt;</span></span>
<span></span>
<span><span class="co"># Get latest version ID</span></span>
<span><span class="va">latest_id</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/st_latest.html">st_latest</a></span><span class="op">(</span><span class="va">test_path</span><span class="op">)</span></span>
<span><span class="va">latest_id</span></span>
<span><span class="co">#&gt; [1] "1b5b0bd1fc1a260f"</span></span>
<span></span>
<span><span class="co"># Get comprehensive info (catalog + sidecar + snapshot location)</span></span>
<span><span class="va">info</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/st_info.html">st_info</a></span><span class="op">(</span><span class="va">test_path</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">info</span>, max.level <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt; List of 4</span></span>
<span><span class="co">#&gt;  $ sidecar     :List of 10</span></span>
<span><span class="co">#&gt;  $ catalog     :List of 2</span></span>
<span><span class="co">#&gt;  $ snapshot_dir: 'fs_path' chr "/tmp/RtmpMf7Yu1/stamp-demo/.stamp/versions/data/test.qs2/1b5b0bd1fc1a260f"</span></span>
<span><span class="co">#&gt;  $ parents     : list()</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="version-snapshots-versions">2.3 Version Snapshots: <code>versions/</code><a class="anchor" aria-label="anchor" href="#version-snapshots-versions"></a>
</h3>
<p>Each time you save an artifact (and versioning is enabled), a new
<strong>immutable snapshot</strong> is created:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Save the same artifact multiple times with changes</span></span>
<span><span class="va">v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/st_save.html">st_save</a></span><span class="op">(</span><span class="va">v1</span>, <span class="va">test_path</span>, code_label <span class="op">=</span> <span class="st">"initial"</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Saved [<span style="color: #00BB00;">qs2</span>] → <span style="color: #0000BB;">/tmp/RtmpMf7Yu1/stamp-demo/data/test.qs2</span> @ version</span></span>
<span><span class="co">#&gt;   <span style="color: #00BB00;">9e03d6d8445546b6</span></span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Sys.sleep.html" class="external-link">Sys.sleep</a></span><span class="op">(</span><span class="fl">0.2</span><span class="op">)</span></span>
<span></span>
<span><span class="va">v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/st_save.html">st_save</a></span><span class="op">(</span><span class="va">v2</span>, <span class="va">test_path</span>, code_label <span class="op">=</span> <span class="st">"added rows"</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Saved [<span style="color: #00BB00;">qs2</span>] → <span style="color: #0000BB;">/tmp/RtmpMf7Yu1/stamp-demo/data/test.qs2</span> @ version</span></span>
<span><span class="co">#&gt;   <span style="color: #00BB00;">230cd8b7bd38f700</span></span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Sys.sleep.html" class="external-link">Sys.sleep</a></span><span class="op">(</span><span class="fl">0.2</span><span class="op">)</span></span>
<span></span>
<span><span class="va">v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, y <span class="op">=</span> <span class="fl">10</span><span class="op">:</span><span class="fl">14</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/st_save.html">st_save</a></span><span class="op">(</span><span class="va">v3</span>, <span class="va">test_path</span>, code_label <span class="op">=</span> <span class="st">"added column"</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Saved [<span style="color: #00BB00;">qs2</span>] → <span style="color: #0000BB;">/tmp/RtmpMf7Yu1/stamp-demo/data/test.qs2</span> @ version</span></span>
<span><span class="co">#&gt;   <span style="color: #00BB00;">413bc3ef258e4c86</span></span></span>
<span></span>
<span><span class="co"># Each version gets its own directory</span></span>
<span><span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/dir_tree.html" class="external-link">dir_tree</a></span><span class="op">(</span><span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path.html" class="external-link">path</a></span><span class="op">(</span><span class="va">demo_dir</span>, <span class="st">".stamp"</span>, <span class="st">"versions"</span><span class="op">)</span>, recurse <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB; font-weight: bold;">/tmp/RtmpMf7Yu1/stamp-demo/.stamp/versions</span></span></span>
<span><span class="co">#&gt; └── <span style="color: #0000BB; font-weight: bold;">data</span></span></span>
<span><span class="co">#&gt;     └── <span style="color: #0000BB; font-weight: bold;">test.qs2</span></span></span>
<span><span class="co">#&gt;         ├── <span style="color: #0000BB; font-weight: bold;">1b5b0bd1fc1a260f</span></span></span>
<span><span class="co">#&gt;         ├── <span style="color: #0000BB; font-weight: bold;">230cd8b7bd38f700</span></span></span>
<span><span class="co">#&gt;         ├── <span style="color: #0000BB; font-weight: bold;">413bc3ef258e4c86</span></span></span>
<span><span class="co">#&gt;         └── <span style="color: #0000BB; font-weight: bold;">9e03d6d8445546b6</span></span></span></code></pre></div>
<p><strong>What’s inside a version snapshot directory?</strong></p>
<ol style="list-style-type: decimal">
<li>
<strong><code>artifact</code></strong> - A complete copy of the file
at that point in time</li>
<li>
<strong><code>sidecar.json</code> /
<code>sidecar.qs2</code></strong> - Metadata including:
<ul>
<li>Content hash</li>
<li>Code hash (if tracked)</li>
<li>File size</li>
<li>Timestamp</li>
<li>Custom metadata tags</li>
<li>Parent references (quick view)</li>
</ul>
</li>
<li>
<strong><code>parents.json</code></strong> - Immutable provenance
chain showing which artifacts this version depends on (only present if
parents were specified)</li>
</ol>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Get the latest version directory path</span></span>
<span><span class="va">latest_vdir</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/st_info.html">st_info</a></span><span class="op">(</span><span class="va">test_path</span><span class="op">)</span><span class="op">$</span><span class="va">snapshot_dir</span></span>
<span></span>
<span><span class="co"># List contents - note: parents.json only exists if parents were specified</span></span>
<span><span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/dir_ls.html" class="external-link">dir_ls</a></span><span class="op">(</span><span class="va">latest_vdir</span><span class="op">)</span></span>
<span><span class="co">#&gt; /tmp/RtmpMf7Yu1/stamp-demo/.stamp/versions/data/test.qs2/413bc3ef258e4c86/artifact</span></span>
<span><span class="co">#&gt; /tmp/RtmpMf7Yu1/stamp-demo/.stamp/versions/data/test.qs2/413bc3ef258e4c86/sidecar.json</span></span>
<span></span>
<span><span class="co"># Read the sidecar from the snapshot</span></span>
<span><span class="va">sidecar_path</span> <span class="op">&lt;-</span> <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path.html" class="external-link">path</a></span><span class="op">(</span><span class="va">latest_vdir</span>, <span class="st">"sidecar.json"</span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/file_access.html" class="external-link">file_exists</a></span><span class="op">(</span><span class="va">sidecar_path</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">sidecar</span> <span class="op">&lt;-</span> <span class="fu">jsonlite</span><span class="fu">::</span><span class="fu"><a href="https://jeroen.r-universe.dev/jsonlite/reference/read_json.html" class="external-link">read_json</a></span><span class="op">(</span><span class="va">sidecar_path</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">sidecar</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"path"</span>, <span class="st">"format"</span>, <span class="st">"created_at"</span>, <span class="st">"size_bytes"</span>, <span class="st">"code_label"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; List of 5</span></span>
<span><span class="co">#&gt;  $ path      : chr "/tmp/RtmpMf7Yu1/stamp-demo/data/test.qs2"</span></span>
<span><span class="co">#&gt;  $ format    : chr "qs2"</span></span>
<span><span class="co">#&gt;  $ created_at: chr "2026-01-15T22:48:58.780020Z"</span></span>
<span><span class="co">#&gt;  $ size_bytes: int 265</span></span>
<span><span class="co">#&gt;  $ code_label: chr "added column"</span></span></code></pre></div>
<p><strong>Example of specifying parents during save:</strong></p>
<p>Notice that the <code>parents.json</code> file is not present in the
example above. This is because it is only created when parents are
specified.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># First, create an upstream artifact</span></span>
<span><span class="va">upstream_path</span> <span class="op">&lt;-</span> <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path.html" class="external-link">path</a></span><span class="op">(</span><span class="va">demo_dir</span>, <span class="st">"data"</span>, <span class="st">"upstream.qs2"</span><span class="op">)</span></span>
<span><span class="va">upstream_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/st_save.html">st_save</a></span><span class="op">(</span><span class="va">upstream_data</span>, <span class="va">upstream_path</span>, code_label <span class="op">=</span> <span class="st">"upstream data"</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Saved [<span style="color: #00BB00;">qs2</span>] → <span style="color: #0000BB;">/tmp/RtmpMf7Yu1/stamp-demo/data/upstream.qs2</span> @ version</span></span>
<span><span class="co">#&gt;   <span style="color: #00BB00;">4857e6d31d9982e7</span></span></span>
<span><span class="va">upstream_version</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/st_latest.html">st_latest</a></span><span class="op">(</span><span class="va">upstream_path</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Now create a derived artifact with parent reference</span></span>
<span><span class="va">derived_path</span> <span class="op">&lt;-</span> <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path.html" class="external-link">path</a></span><span class="op">(</span><span class="va">demo_dir</span>, <span class="st">"data"</span>, <span class="st">"derived.qs2"</span><span class="op">)</span></span>
<span><span class="va">derived_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, transformed <span class="op">=</span> <span class="va">upstream_data</span><span class="op">$</span><span class="va">value</span> <span class="op">*</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/st_save.html">st_save</a></span><span class="op">(</span></span>
<span>  <span class="va">derived_data</span>, </span>
<span>  <span class="va">derived_path</span>,</span>
<span>  parents <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>path <span class="op">=</span> <span class="va">upstream_path</span>, version_id <span class="op">=</span> <span class="va">upstream_version</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  code_label <span class="op">=</span> <span class="st">"derived from upstream"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Saved [<span style="color: #00BB00;">qs2</span>] → <span style="color: #0000BB;">/tmp/RtmpMf7Yu1/stamp-demo/data/derived.qs2</span> @ version</span></span>
<span><span class="co">#&gt;   <span style="color: #00BB00;">c24245407a03110f</span></span></span>
<span></span>
<span><span class="co"># Now check the derived artifact's snapshot - parents.json will be present</span></span>
<span><span class="va">derived_vdir</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/st_info.html">st_info</a></span><span class="op">(</span><span class="va">derived_path</span><span class="op">)</span><span class="op">$</span><span class="va">snapshot_dir</span></span>
<span><span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/dir_ls.html" class="external-link">dir_ls</a></span><span class="op">(</span><span class="va">derived_vdir</span><span class="op">)</span></span>
<span><span class="co">#&gt; /tmp/RtmpMf7Yu1/stamp-demo/.stamp/versions/data/derived.qs2/c24245407a03110f/artifact</span></span>
<span><span class="co">#&gt; /tmp/RtmpMf7Yu1/stamp-demo/.stamp/versions/data/derived.qs2/c24245407a03110f/parents.json</span></span>
<span><span class="co">#&gt; /tmp/RtmpMf7Yu1/stamp-demo/.stamp/versions/data/derived.qs2/c24245407a03110f/sidecar.json</span></span>
<span></span>
<span><span class="co"># Read parents.json</span></span>
<span><span class="va">parents_file</span> <span class="op">&lt;-</span> <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path.html" class="external-link">path</a></span><span class="op">(</span><span class="va">derived_vdir</span>, <span class="st">"parents.json"</span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/file_access.html" class="external-link">file_exists</a></span><span class="op">(</span><span class="va">parents_file</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">parents</span> <span class="op">&lt;-</span> <span class="fu">jsonlite</span><span class="fu">::</span><span class="fu"><a href="https://jeroen.r-universe.dev/jsonlite/reference/read_json.html" class="external-link">read_json</a></span><span class="op">(</span><span class="va">parents_file</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">parents</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; List of 1</span></span>
<span><span class="co">#&gt;  $ :List of 2</span></span>
<span><span class="co">#&gt;   ..$ path      : chr "/tmp/RtmpMf7Yu1/stamp-demo/data/upstream.qs2"</span></span>
<span><span class="co">#&gt;   ..$ version_id: chr "4857e6d31d9982e7"</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="artifact-organization-path-based-vs--external-storage">2.4 Artifact Organization: Path-Based vs. External Storage<a class="anchor" aria-label="anchor" href="#artifact-organization-path-based-vs--external-storage"></a>
</h3>
<p>The <code>versions/</code> directory organizes snapshots differently
depending on whether the artifact is <strong>inside or outside your
project directory</strong>. This affects how you’ll find version
snapshots on disk.</p>
<div class="section level4">
<h4 id="artifacts-inside-project-root-path-based-organization">Artifacts Inside Project Root (Path-Based Organization)<a class="anchor" aria-label="anchor" href="#artifacts-inside-project-root-path-based-organization"></a>
</h4>
<p>When you save an artifact that lives inside your project directory,
stamp mirrors the <strong>relative path</strong> structure:</p>
<p><strong>Example:</strong> Project root is
<code>/home/user/myproject/</code>, and you save
<code>/home/user/myproject/data/cleaned.rds</code></p>
<pre><code>.stamp/versions/
└── data/                        # Mirrors the relative path "data/"
    └── cleaned.rds/             # One directory per artifact
        ├── 20250108T121500Z-abc12345/  # Version 1
        ├── 20250108T143000Z-def67890/  # Version 2
        └── 20250108T165500Z-ghi13579/  # Version 3</code></pre>
<p>The path <code>data/cleaned.rds/</code> mirrors your project
structure, making versions easy to locate.</p>
</div>
<div class="section level4">
<h4 id="artifacts-outside-project-root-hash-based-organization">Artifacts Outside Project Root (Hash-Based Organization)<a class="anchor" aria-label="anchor" href="#artifacts-outside-project-root-hash-based-organization"></a>
</h4>
<p>When you save an artifact <strong>outside</strong> your project
directory (e.g., in a temp folder or shared drive), stamp cannot use a
relative path. Instead, it uses a <strong>hash-based identifier</strong>
to prevent naming collisions:</p>
<p><strong>Example:</strong> Project root is
<code>/home/user/myproject/</code>, but you save
<code>/tmp/external_data.csv</code></p>
<pre><code>.stamp/versions/
└── external/                    # Special folder for out-of-project artifacts
    └── a1b2c3d4-external_data.csv/   # Hash prefix + basename
        ├── 20250108T121500Z-abc12345/
        └── 20250108T143000Z-def67890/</code></pre>
<p>Here <code>a1b2c3d4</code> is the first 8 characters of the
artifact’s unique ID (hash of its absolute path). This ensures that two
files with the same name but different absolute paths don’t collide.</p>
</div>
<div class="section level4">
<h4 id="real-world-example">Real-World Example<a class="anchor" aria-label="anchor" href="#real-world-example"></a>
</h4>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Scenario 1: File inside project (uses relative path)</span></span>
<span><span class="va">project_file</span> <span class="op">&lt;-</span> <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path.html" class="external-link">path</a></span><span class="op">(</span><span class="va">demo_dir</span>, <span class="st">"outputs"</span>, <span class="st">"results.qs2"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/st_save.html">st_save</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span>, <span class="va">project_file</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Versions stored at: .stamp/versions/outputs/results.qs2/</span></span>
<span><span class="co"># ✓ Easy to navigate - mirrors your project structure</span></span>
<span></span>
<span><span class="co"># Scenario 2: File outside project (uses hash + basename)</span></span>
<span><span class="va">external_file</span> <span class="op">&lt;-</span> <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/file_temp.html" class="external-link">path_temp</a></span><span class="op">(</span><span class="st">"temp_results.qs2"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/st_save.html">st_save</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>y <span class="op">=</span> <span class="fl">6</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span>, <span class="va">external_file</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Versions stored at: .stamp/versions/external/&lt;hash&gt;-temp_results.qs2/</span></span>
<span><span class="co"># ✓ Collision-free - different absolute paths get different hashes</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="why-this-matters">Why This Matters<a class="anchor" aria-label="anchor" href="#why-this-matters"></a>
</h4>
<ol style="list-style-type: decimal">
<li>
<strong>Inside project</strong>: Intuitive navigation - version
directories match your project structure</li>
<li>
<strong>Outside project</strong>: Still tracked, but requires using
<code><a href="../reference/st_info.html">st_info()</a></code> to find the exact snapshot location</li>
<li>
<strong>Collision safety</strong>: Two files named
<code>data.csv</code> at different absolute paths never conflict</li>
</ol>
<p><strong>Best practice:</strong> Keep artifacts inside your project
directory when possible for easier manual inspection of the
<code>.stamp/versions/</code> tree.</p>
<hr>
</div>
</div>
</div>
<div class="section level2">
<h2 id="how-versioning-works">3. How Versioning Works<a class="anchor" aria-label="anchor" href="#how-versioning-works"></a>
</h2>
<div class="section level3">
<h3 id="the-version-creation-process">3.1 The Version Creation Process<a class="anchor" aria-label="anchor" href="#the-version-creation-process"></a>
</h3>
<p>When you call <code><a href="../reference/st_save.html">st_save()</a></code>, here’s what happens
internally:</p>
<pre><code>┌─────────────────────────────────────────────────────────────────┐
│                       st_save(data, path)                       │
└─────────────────────────┬───────────────────────────────────────┘
                          │
                          ▼
         ┌────────────────────────────────────────┐
         │  1. Decide if save is needed           │
         │     (st_should_save)                   │
         ├────────────────────────────────────────┤
         │  • Check if file exists                │
         │  • Compare content hash                │
         │  • Compare code hash                   │
         │  • Check versioning policy             │
         └────────────────┬───────────────────────┘
                          │
                          ▼
         ┌────────────────────────────────────────┐
         │  2. Write artifact atomically          │
         ├────────────────────────────────────────┤
         │  • Write to temp file                  │
         │  • Move to destination (atomic)        │
         └────────────────┬───────────────────────┘
                          │
                          ▼
         ┌────────────────────────────────────────┐
         │  3. Write sidecar metadata             │
         ├────────────────────────────────────────┤
         │  • Compute hashes                      │
         │  • Record timestamp                    │
         │  • Store in stmeta/ directory          │
         └────────────────┬───────────────────────┘
                          │
                          ▼
         ┌────────────────────────────────────────┐
         │  4. Update catalog                     │
         ├────────────────────────────────────────┤
         │  • Add version row to catalog          │
         │  • Update artifact's latest_version_id │
         │  • Increment n_versions counter        │
         └────────────────┬───────────────────────┘
                          │
                          ▼
         ┌────────────────────────────────────────┐
         │  5. Create version snapshot            │
         ├────────────────────────────────────────┤
         │  • Copy artifact to versions/          │
         │  • Copy sidecars                       │
         │  • Write parents.json                  │
         └────────────────┬───────────────────────┘
                          │
                          ▼
         ┌────────────────────────────────────────┐
         │  6. Apply retention policy             │
         │     (if configured)                    │
         ├────────────────────────────────────────┤
         │  • Prune old versions based on policy  │
         └────────────────────────────────────────┘</code></pre>
<p>Each step is designed to be <strong>atomic and crash-safe</strong>,
ensuring that partial writes never corrupt your version history.</p>
</div>
<div class="section level3">
<h3 id="version-identifiers">3.2 Version Identifiers<a class="anchor" aria-label="anchor" href="#version-identifiers"></a>
</h3>
<p>Version IDs are deterministic hashes combining:</p>
<ul>
<li>Timestamp (microsecond precision)</li>
<li>Content hash</li>
<li>Code hash (if available)</li>
<li>Artifact ID</li>
</ul>
<p>Example: <code>20250108T121507123456Z-abc12345</code></p>
<p>This ensures:</p>
<ul>
<li>
<strong>Chronological ordering</strong> - Timestamps sort
naturally</li>
<li>
<strong>Uniqueness</strong> - Hash suffix prevents collisions</li>
<li>
<strong>Traceability</strong> - Hash links to specific content
state</li>
</ul>
</div>
<div class="section level3">
<h3 id="versioning-modes">3.3 Versioning Modes<a class="anchor" aria-label="anchor" href="#versioning-modes"></a>
</h3>
<p>Control versioning behavior with <code><a href="../reference/st_opts.html">st_opts()</a></code>:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Show current versioning mode</span></span>
<span><span class="fu"><a href="../reference/st_opts.html">st_opts</a></span><span class="op">(</span><span class="st">"versioning"</span>, .get <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "content"</span></span>
<span></span>
<span><span class="co"># Available modes:</span></span>
<span><span class="co"># - "content" (default): Save version only when content or code changes</span></span>
<span><span class="co"># - "timestamp": Save version on every st_save() call</span></span>
<span><span class="co"># - "off": Disable versioning (only update current file + sidecar)</span></span>
<span></span>
<span><span class="co"># Example: Force version on every save</span></span>
<span><span class="fu"><a href="../reference/st_opts.html">st_opts</a></span><span class="op">(</span>versioning <span class="op">=</span> <span class="st">"timestamp"</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> stamp options updated</span></span>
<span><span class="co">#&gt;   versioning = <span style="color: #0000BB;">"timestamp"</span></span></span>
<span><span class="va">v_same</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/st_save.html">st_save</a></span><span class="op">(</span><span class="va">v_same</span>, <span class="va">test_path</span>, code_label <span class="op">=</span> <span class="st">"first"</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Saved [<span style="color: #00BB00;">qs2</span>] → <span style="color: #0000BB;">/tmp/RtmpMf7Yu1/stamp-demo/data/test.qs2</span> @ version</span></span>
<span><span class="co">#&gt;   <span style="color: #00BB00;">8b41e2e2c3acbedd</span></span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Sys.sleep.html" class="external-link">Sys.sleep</a></span><span class="op">(</span><span class="fl">0.2</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/st_save.html">st_save</a></span><span class="op">(</span><span class="va">v_same</span>, <span class="va">test_path</span>, code_label <span class="op">=</span> <span class="st">"second identical"</span><span class="op">)</span>  <span class="co"># Still creates version!</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Saved [<span style="color: #00BB00;">qs2</span>] → <span style="color: #0000BB;">/tmp/RtmpMf7Yu1/stamp-demo/data/test.qs2</span> @ version</span></span>
<span><span class="co">#&gt;   <span style="color: #00BB00;">a927cada2ac74987</span></span></span>
<span></span>
<span><span class="co"># Check: two versions with identical content</span></span>
<span><span class="va">recent_versions</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/st_versions.html">st_versions</a></span><span class="op">(</span><span class="va">test_path</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">(</span><span class="va">recent_versions</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span><span class="va">version_id</span>, <span class="va">created_at</span>, <span class="va">content_hash</span><span class="op">)</span><span class="op">]</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#&gt;          version_id                  created_at     content_hash</span></span>
<span><span class="co">#&gt;              &lt;char&gt;                      &lt;char&gt;           &lt;char&gt;</span></span>
<span><span class="co">#&gt; 1: 9e03d6d8445546b6 2026-01-15T22:48:58.212397Z 41c16cfe6598913b</span></span>
<span><span class="co">#&gt; 2: 1b5b0bd1fc1a260f 2026-01-15T22:48:57.747827Z 2d26c6e5d9121bfd</span></span>
<span></span>
<span><span class="co"># Reset to default</span></span>
<span><span class="fu"><a href="../reference/st_opts.html">st_opts</a></span><span class="op">(</span>versioning <span class="op">=</span> <span class="st">"content"</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> stamp options updated</span></span>
<span><span class="co">#&gt;   versioning = <span style="color: #0000BB;">"content"</span></span></span></code></pre></div>
<hr>
</div>
</div>
<div class="section level2">
<h2 id="developer-details">4. Developer Details<a class="anchor" aria-label="anchor" href="#developer-details"></a>
</h2>
<div class="section level3">
<h3 id="key-internal-functions">4.1 Key Internal Functions<a class="anchor" aria-label="anchor" href="#key-internal-functions"></a>
</h3>
<p>These functions power the <code>.stamp/</code> infrastructure (from
<code>R/version_store.R</code>):</p>
<p><strong>Path and ID Management:</strong></p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/dot-st_norm_path.html">.st_norm_path</a></span><span class="op">(</span><span class="va">path</span><span class="op">)</span>           <span class="co"># Normalize path to absolute canonical form</span></span>
<span><span class="fu"><a href="../reference/dot-st_artifact_id.html">.st_artifact_id</a></span><span class="op">(</span><span class="va">path</span><span class="op">)</span>         <span class="co"># Compute stable hash identifier from path</span></span>
<span><span class="fu"><a href="../reference/dot-st_root_dir.html">.st_root_dir</a></span><span class="op">(</span><span class="op">)</span>                <span class="co"># Get project root from st_init()</span></span>
<span><span class="fu"><a href="../reference/dot-st_state_dir_abs.html">.st_state_dir_abs</a></span><span class="op">(</span><span class="op">)</span>           <span class="co"># Get absolute .stamp/ path</span></span></code></pre></div>
<p><strong>Catalog Operations:</strong></p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/dot-st_catalog_path.html">.st_catalog_path</a></span><span class="op">(</span><span class="op">)</span>            <span class="co"># Path to catalog.qs2</span></span>
<span><span class="fu"><a href="../reference/dot-st_catalog_read.html">.st_catalog_read</a></span><span class="op">(</span><span class="op">)</span>            <span class="co"># Read catalog (or create empty if missing)</span></span>
<span><span class="fu"><a href="../reference/dot-st_catalog_write.html">.st_catalog_write</a></span><span class="op">(</span><span class="va">cat</span><span class="op">)</span>        <span class="co"># Atomic catalog write with locking</span></span>
<span><span class="fu"><a href="../reference/dot-st_catalog_record_version.html">.st_catalog_record_version</a></span><span class="op">(</span><span class="op">)</span>  <span class="co"># Add new version row to catalog</span></span></code></pre></div>
<p><strong>Version Management:</strong></p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/dot-st_versions_root.html">.st_versions_root</a></span><span class="op">(</span><span class="op">)</span>           <span class="co"># Get versions/ directory path</span></span>
<span><span class="fu"><a href="../reference/dot-st_version_dir.html">.st_version_dir</a></span><span class="op">(</span><span class="va">path</span>, <span class="va">vid</span><span class="op">)</span>    <span class="co"># Compute specific version snapshot path</span></span>
<span><span class="fu"><a href="../reference/dot-st_version_commit_files.html">.st_version_commit_files</a></span><span class="op">(</span><span class="op">)</span>    <span class="co"># Copy artifact + sidecars to snapshot</span></span>
<span><span class="fu"><a href="../reference/dot-st_version_read_parents.html">.st_version_read_parents</a></span><span class="op">(</span><span class="op">)</span>    <span class="co"># Read parents.json from snapshot</span></span>
<span><span class="fu"><a href="../reference/dot-st_version_write_parents.html">.st_version_write_parents</a></span><span class="op">(</span><span class="op">)</span>   <span class="co"># Write parents.json to snapshot</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="concurrency-and-safety">4.2 Concurrency and Safety<a class="anchor" aria-label="anchor" href="#concurrency-and-safety"></a>
</h3>
<div class="section level4">
<h4 id="file-based-locking-explained">File-Based Locking Explained<a class="anchor" aria-label="anchor" href="#file-based-locking-explained"></a>
</h4>
<p><strong>The Problem:</strong> Imagine two R sessions running
simultaneously, both trying to save artifacts:</p>
<pre><code>Session A: Reads catalog → Modifies → Writes back
Session B: Reads catalog → Modifies → Writes back</code></pre>
<p>Without coordination, Session B might overwrite Session A’s changes,
<strong>losing version records</strong>.</p>
<p><strong>The Solution:</strong> <code>stamp</code> uses
<strong>file-based locking</strong> to ensure only one process modifies
the catalog at a time:</p>
<pre><code>Session A: Acquires lock → Reads → Modifies → Writes → Releases lock
Session B: Waits for lock → Acquires lock → Reads → Modifies → Writes → Releases lock</code></pre>
<p>This is implemented via a lock file
(<code>.stamp/catalog.lock</code>):</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Internal locking mechanism (simplified)</span></span>
<span><span class="fu">.st_with_lock</span><span class="op">(</span><span class="va">path</span>, <span class="op">{</span></span>
<span>  <span class="va">cat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dot-st_catalog_read.html">.st_catalog_read</a></span><span class="op">(</span><span class="op">)</span>     <span class="co"># Read catalog safely</span></span>
<span>  <span class="co"># ... modify catalog ...       # Make changes</span></span>
<span>  <span class="fu"><a href="../reference/dot-st_catalog_write.html">.st_catalog_write</a></span><span class="op">(</span><span class="va">cat</span><span class="op">)</span>         <span class="co"># Write back safely</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Lock file: .stamp/catalog.lock</span></span>
<span><span class="co"># - Created automatically during catalog updates</span></span>
<span><span class="co"># - Uses filelock package if available (recommended)</span></span>
<span><span class="co"># - 5-second timeout prevents permanent deadlocks</span></span>
<span><span class="co"># - Automatically cleaned up after operation completes</span></span></code></pre></div>
<p><strong>Real-world scenarios where locking matters:</strong></p>
<ol style="list-style-type: decimal">
<li>
<strong>Parallel processing:</strong> Running
<code>future::plan(multisession)</code> with multiple workers saving
artifacts</li>
<li>
<strong>Shared filesystems:</strong> Multiple analysts on a server
saving to the same project</li>
<li>
<strong>Background jobs:</strong> RStudio background jobs running
<code><a href="../reference/st_save.html">st_save()</a></code> while you work interactively</li>
</ol>
<p><strong>What happens without the filelock package?</strong></p>
<ul>
<li>
<code>stamp</code> falls back to <strong>advisory locking</strong>
(no enforcement, relies on cooperation)</li>
<li>Risk of corruption increases in high-concurrency scenarios</li>
<li>Install <code>filelock</code> for production use:
<code>install.packages("filelock")</code>
</li>
</ul>
</div>
<div class="section level4">
<h4 id="atomic-operations">Atomic Operations<a class="anchor" aria-label="anchor" href="#atomic-operations"></a>
</h4>
<p>Beyond locking, <code>stamp</code> uses <strong>atomic
operations</strong> to prevent partial writes that could corrupt your
data.</p>
<p><strong>What “atomic” means:</strong> An operation that either
completes entirely or fails entirely, with no in-between state visible
to other processes.</p>
<p><strong>Why this matters:</strong> Consider what could go wrong
without atomicity:</p>
<pre><code># Bad scenario (non-atomic):
1. Start writing new data to file
2. ❌ CRASH (power outage, R session killed, etc.)
3. File now contains partial/corrupt data
4. Version history references a broken file</code></pre>
<p><strong>How stamp ensures atomicity:</strong></p>
<ul>
<li>
<strong>File writes:</strong> Always write to temp file → move to
final location (filesystem-level atomic operation)</li>
<li>
<strong>Catalog updates:</strong> Read-modify-write under lock
ensures serialized updates</li>
<li>
<strong>Version snapshots:</strong> Immutable once created (copy
operations, never modified)</li>
</ul>
<hr>
</div>
</div>
</div>
<div class="section level2">
<h2 id="inspecting--stamp-programmatically">5. Inspecting <code>.stamp/</code> Programmatically<a class="anchor" aria-label="anchor" href="#inspecting--stamp-programmatically"></a>
</h2>
<div class="section level3">
<h3 id="user-level-inspection">5.1 User-Level Inspection<a class="anchor" aria-label="anchor" href="#user-level-inspection"></a>
</h3>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># List all versions of an artifact</span></span>
<span><span class="va">versions</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/st_versions.html">st_versions</a></span><span class="op">(</span><span class="va">test_path</span><span class="op">)</span></span>
<span><span class="va">versions</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span><span class="va">version_id</span>, <span class="va">created_at</span>, <span class="va">size_bytes</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="co">#&gt;          version_id                  created_at size_bytes</span></span>
<span><span class="co">#&gt;              &lt;char&gt;                      &lt;char&gt;      &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1: a927cada2ac74987 2026-01-15T22:48:59.498747Z        245</span></span>
<span><span class="co">#&gt; 2: 8b41e2e2c3acbedd 2026-01-15T22:48:59.258103Z        245</span></span>
<span><span class="co">#&gt; 3: 413bc3ef258e4c86 2026-01-15T22:48:58.780020Z        265</span></span>
<span><span class="co">#&gt; 4: 230cd8b7bd38f700 2026-01-15T22:48:58.533339Z        246</span></span>
<span><span class="co">#&gt; 5: 9e03d6d8445546b6 2026-01-15T22:48:58.212397Z        245</span></span>
<span><span class="co">#&gt; 6: 1b5b0bd1fc1a260f 2026-01-15T22:48:57.747827Z        262</span></span>
<span></span>
<span><span class="co"># Get comprehensive info</span></span>
<span><span class="va">info</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/st_info.html">st_info</a></span><span class="op">(</span><span class="va">test_path</span><span class="op">)</span></span>
<span><span class="va">info</span><span class="op">$</span><span class="va">catalog</span>  <span class="co"># Latest version and count</span></span>
<span><span class="co">#&gt; $latest_version_id</span></span>
<span><span class="co">#&gt; [1] "a927cada2ac74987"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $n_versions</span></span>
<span><span class="co">#&gt; [1] 6</span></span>
<span><span class="va">info</span><span class="op">$</span><span class="va">snapshot_dir</span>  <span class="co"># Path to latest snapshot</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB; font-weight: bold;">/tmp/RtmpMf7Yu1/stamp-demo/.stamp/versions/data/test.qs2/a927cada2ac74987</span></span></span>
<span></span>
<span><span class="co"># Load a specific historical version</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">versions</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">old_version</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/st_load.html">st_load</a></span><span class="op">(</span><span class="va">test_path</span>, version <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span>  <span class="co"># Previous version</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">old_version</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Loaded ← <span style="color: #00BB00;">/tmp/RtmpMf7Yu1/stamp-demo/data/test.qs2</span> @</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">8b41e2e2c3acbedd</span> [<span style="color: #00BB00;">qs2</span>]</span></span>
<span><span class="co">#&gt; 'data.frame':    3 obs. of  1 variable:</span></span>
<span><span class="co">#&gt;  $ x: int  1 2 3</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="direct-catalog-access-advanced">5.2 Direct Catalog Access (Advanced)<a class="anchor" aria-label="anchor" href="#direct-catalog-access-advanced"></a>
</h3>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># NOT recommended for users, but useful for debugging</span></span>
<span><span class="va">catalog_path</span> <span class="op">&lt;-</span> <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path.html" class="external-link">path</a></span><span class="op">(</span><span class="va">demo_dir</span>, <span class="st">".stamp"</span>, <span class="st">"catalog.qs2"</span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/file_access.html" class="external-link">file_exists</a></span><span class="op">(</span><span class="va">catalog_path</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">cat</span> <span class="op">&lt;-</span> <span class="fu">qs2</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/qs2/man/qs_read.html" class="external-link">qs_read</a></span><span class="op">(</span><span class="va">catalog_path</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># View all artifacts</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">cat</span><span class="op">$</span><span class="va">artifacts</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># View all versions</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">cat</span><span class="op">$</span><span class="va">versions</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="exploring-snapshots">5.3 Exploring Snapshots<a class="anchor" aria-label="anchor" href="#exploring-snapshots"></a>
</h3>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Get all version directories for an artifact</span></span>
<span><span class="va">versions_root</span> <span class="op">&lt;-</span> <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path.html" class="external-link">path</a></span><span class="op">(</span><span class="va">demo_dir</span>, <span class="st">".stamp"</span>, <span class="st">"versions"</span><span class="op">)</span></span>
<span><span class="va">artifact_dir</span> <span class="op">&lt;-</span> <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path.html" class="external-link">path</a></span><span class="op">(</span><span class="va">versions_root</span>, <span class="st">"data"</span>, <span class="st">"test.qs2"</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/file_access.html" class="external-link">dir_exists</a></span><span class="op">(</span><span class="va">artifact_dir</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># List all version snapshots</span></span>
<span>  <span class="va">snapshot_dirs</span> <span class="op">&lt;-</span> <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/dir_ls.html" class="external-link">dir_ls</a></span><span class="op">(</span><span class="va">artifact_dir</span>, type <span class="op">=</span> <span class="st">"directory"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Inspect contents of latest snapshot</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">snapshot_dirs</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">latest</span> <span class="op">&lt;-</span> <span class="va">snapshot_dirs</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">snapshot_dirs</span><span class="op">)</span><span class="op">]</span></span>
<span>    <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/dir_tree.html" class="external-link">dir_tree</a></span><span class="op">(</span><span class="va">latest</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># Read parents.json if present</span></span>
<span>    <span class="va">parents_file</span> <span class="op">&lt;-</span> <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path.html" class="external-link">path</a></span><span class="op">(</span><span class="va">latest</span>, <span class="st">"parents.json"</span><span class="op">)</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/file_access.html" class="external-link">file_exists</a></span><span class="op">(</span><span class="va">parents_file</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">parents</span> <span class="op">&lt;-</span> <span class="fu">jsonlite</span><span class="fu">::</span><span class="fu"><a href="https://jeroen.r-universe.dev/jsonlite/reference/read_json.html" class="external-link">read_json</a></span><span class="op">(</span><span class="va">parents_file</span><span class="op">)</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">parents</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB; font-weight: bold;">/tmp/RtmpMf7Yu1/stamp-demo/.stamp/versions/data/test.qs2/a927cada2ac74987</span></span></span>
<span><span class="co">#&gt; ├── artifact</span></span>
<span><span class="co">#&gt; └── sidecar.json</span></span></code></pre></div>
<hr>
</div>
</div>
<div class="section level2">
<h2 id="troubleshooting">6. Troubleshooting<a class="anchor" aria-label="anchor" href="#troubleshooting"></a>
</h2>
<div class="section level3">
<h3 id="missing-or-corrupt--stamp-directory">6.1 Missing or Corrupt <code>.stamp/</code> Directory<a class="anchor" aria-label="anchor" href="#missing-or-corrupt--stamp-directory"></a>
</h3>
<p><strong>Symptom:</strong> Functions like <code><a href="../reference/st_versions.html">st_versions()</a></code>
return empty results or error.</p>
<p><strong>Diagnosis:</strong></p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Check if .stamp exists</span></span>
<span><span class="va">stamp_dir</span> <span class="op">&lt;-</span> <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path.html" class="external-link">path</a></span><span class="op">(</span><span class="va">demo_dir</span>, <span class="st">".stamp"</span><span class="op">)</span></span>
<span><span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/file_access.html" class="external-link">dir_exists</a></span><span class="op">(</span><span class="va">stamp_dir</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Check if catalog exists</span></span>
<span><span class="va">catalog_path</span> <span class="op">&lt;-</span> <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path.html" class="external-link">path</a></span><span class="op">(</span><span class="va">stamp_dir</span>, <span class="st">"catalog.qs2"</span><span class="op">)</span></span>
<span><span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/file_access.html" class="external-link">file_exists</a></span><span class="op">(</span><span class="va">catalog_path</span><span class="op">)</span></span></code></pre></div>
<p><strong>Solution:</strong></p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Re-initialize (safe, won't delete existing data)</span></span>
<span><span class="fu"><a href="../reference/st_init.html">st_init</a></span><span class="op">(</span><span class="va">demo_dir</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># If catalog is corrupt, it will be recreated empty on first st_save()</span></span>
<span><span class="co"># Note: This means version history is lost - restore from backup if available</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="catalog-schema-mismatch">6.2 Catalog Schema Mismatch<a class="anchor" aria-label="anchor" href="#catalog-schema-mismatch"></a>
</h3>
<p><strong>Symptom:</strong> Error: “Catalog schema mismatch in versions
table.”</p>
<p><strong>Cause:</strong> Package upgrade changed catalog structure, or
manual corruption.</p>
<p><strong>Solution:</strong></p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Back up existing catalog</span></span>
<span><span class="va">backup_path</span> <span class="op">&lt;-</span> <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path.html" class="external-link">path</a></span><span class="op">(</span><span class="va">stamp_dir</span>, <span class="st">"catalog_backup.qs2"</span><span class="op">)</span></span>
<span><span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/copy.html" class="external-link">file_copy</a></span><span class="op">(</span><span class="va">catalog_path</span>, <span class="va">backup_path</span>, overwrite <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Option 1: Delete catalog and rebuild (LOSES VERSION HISTORY)</span></span>
<span><span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/delete.html" class="external-link">file_delete</a></span><span class="op">(</span><span class="va">catalog_path</span><span class="op">)</span></span>
<span><span class="co"># Next st_save() will create fresh catalog</span></span>
<span></span>
<span><span class="co"># Option 2: Manual migration (advanced - contact package maintainer)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="disk-space-issues">6.3 Disk Space Issues<a class="anchor" aria-label="anchor" href="#disk-space-issues"></a>
</h3>
<p><strong>Symptom:</strong> <code>.stamp/versions/</code> grows very
large.</p>
<p><strong>Diagnosis:</strong></p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Check total size</span></span>
<span><span class="va">info</span> <span class="op">&lt;-</span> <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/dir_ls.html" class="external-link">dir_info</a></span><span class="op">(</span><span class="va">stamp_dir</span>, recurse <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span>total_mb <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">info</span><span class="op">$</span><span class="va">size</span><span class="op">)</span> <span class="op">/</span> <span class="fl">1024</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Find largest directories</span></span>
<span><span class="va">info</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/as.data.table.html" class="external-link">as.data.table</a></span><span class="op">(</span></span>
<span>  <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/dir_ls.html" class="external-link">dir_info</a></span><span class="op">(</span><span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path.html" class="external-link">path</a></span><span class="op">(</span><span class="va">stamp_dir</span>, <span class="st">"versions"</span><span class="op">)</span>, recurse <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">info</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="op">-</span><span class="va">size</span><span class="op">)</span><span class="op">]</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span></span></code></pre></div>
<p><strong>Solution:</strong></p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Configure retention policy to auto-prune old versions</span></span>
<span><span class="fu"><a href="../reference/st_opts.html">st_opts</a></span><span class="op">(</span>retention_policy <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">10</span>, days <span class="op">=</span> <span class="fl">90</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Manually prune versions for specific artifact</span></span>
<span><span class="fu"><a href="../reference/st_prune_versions.html">st_prune_versions</a></span><span class="op">(</span><span class="va">test_path</span>, policy <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>, dry_run <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Prune all artifacts (use with caution!)</span></span>
<span><span class="va">catalog</span> <span class="op">&lt;-</span> <span class="fu">stamp</span><span class="fu">:::</span><span class="fu"><a href="../reference/dot-st_catalog_read.html">.st_catalog_read</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">aid</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">catalog</span><span class="op">$</span><span class="va">versions</span><span class="op">$</span><span class="va">artifact_id</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">artifact_path</span> <span class="op">&lt;-</span> <span class="va">catalog</span><span class="op">$</span><span class="va">artifacts</span><span class="op">[</span><span class="va">artifact_id</span> <span class="op">==</span> <span class="va">aid</span><span class="op">]</span><span class="op">$</span><span class="va">path</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="fu"><a href="../reference/st_prune_versions.html">st_prune_versions</a></span><span class="op">(</span><span class="va">artifact_path</span>, policy <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>, dry_run <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="version-timestamp-issues">6.4 Version Timestamp Issues<a class="anchor" aria-label="anchor" href="#version-timestamp-issues"></a>
</h3>
<p><strong>Symptom:</strong> Timestamps appear corrupted or versions
won’t load.</p>
<p><strong>Diagnosis:</strong></p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Check for invalid timestamps</span></span>
<span><span class="va">vers</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/st_versions.html">st_versions</a></span><span class="op">(</span><span class="va">test_path</span><span class="op">)</span></span>
<span><span class="va">bad_timestamps</span> <span class="op">&lt;-</span> <span class="va">vers</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">created_at</span><span class="op">)</span> <span class="op">|</span> <span class="va">created_at</span> <span class="op">==</span> <span class="st">""</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">bad_timestamps</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0</span></span></code></pre></div>
<p><strong>Solution:</strong> The package automatically drops corrupt
version rows when reading. If this happens frequently, check for:</p>
<ul>
<li>System clock issues</li>
<li>Concurrent access without proper locking</li>
<li>Manual modification of catalog files</li>
</ul>
</div>
<div class="section level3">
<h3 id="artifacts-outside-project-root">6.5 Artifacts Outside Project Root<a class="anchor" aria-label="anchor" href="#artifacts-outside-project-root"></a>
</h3>
<p><strong>Symptom:</strong> Can’t find version snapshots for artifacts
outside the project directory.</p>
<p><strong>Explanation:</strong> These are stored in
<code>versions/external/</code> with a special naming convention.</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Artifact outside project root</span></span>
<span><span class="va">external_path</span> <span class="op">&lt;-</span> <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/file_temp.html" class="external-link">path_temp</a></span><span class="op">(</span><span class="st">"external_data.csv"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/st_save.html">st_save</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>a <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span>, <span class="va">external_path</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Snapshot is under external/</span></span>
<span><span class="va">aid</span> <span class="op">&lt;-</span> <span class="fu">stamp</span><span class="fu">:::</span><span class="fu"><a href="../reference/dot-st_artifact_id.html">.st_artifact_id</a></span><span class="op">(</span><span class="va">external_path</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/substr.html" class="external-link">substr</a></span><span class="op">(</span><span class="va">aid</span>, <span class="fl">1</span>, <span class="fl">8</span><span class="op">)</span>  <span class="co"># First 8 chars used in directory name</span></span>
<span></span>
<span><span class="va">external_dir</span> <span class="op">&lt;-</span> <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path.html" class="external-link">path</a></span><span class="op">(</span><span class="va">stamp_dir</span>, <span class="st">"versions"</span>, <span class="st">"external"</span><span class="op">)</span></span>
<span><span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/dir_ls.html" class="external-link">dir_ls</a></span><span class="op">(</span><span class="va">external_dir</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="lock-file-issues">6.6 Lock File Issues<a class="anchor" aria-label="anchor" href="#lock-file-issues"></a>
</h3>
<p><strong>Symptom:</strong> <code>catalog.lock</code> file persists
after crash.</p>
<p><strong>Solution:</strong></p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Safe to delete if no stamp operations are running</span></span>
<span><span class="va">lock_file</span> <span class="op">&lt;-</span> <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path.html" class="external-link">path</a></span><span class="op">(</span><span class="va">stamp_dir</span>, <span class="st">"catalog.lock"</span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/file_access.html" class="external-link">file_exists</a></span><span class="op">(</span><span class="va">lock_file</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/delete.html" class="external-link">file_delete</a></span><span class="op">(</span><span class="va">lock_file</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<hr>
</div>
</div>
<div class="section level2">
<h2 id="best-practices">7. Best Practices<a class="anchor" aria-label="anchor" href="#best-practices"></a>
</h2>
<div class="section level3">
<h3 id="version-control-integration">7.1 Version Control Integration<a class="anchor" aria-label="anchor" href="#version-control-integration"></a>
</h3>
<p><strong>Include in <code>.gitignore</code>:</strong></p>
<pre><code><span><span class="va">.stamp</span><span class="op">/</span><span class="va">temp</span><span class="op">/</span></span>
<span><span class="va">.stamp</span><span class="op">/</span><span class="va">logs</span><span class="op">/</span></span>
<span><span class="va">.stamp</span><span class="op">/</span><span class="va">catalog.lock</span></span></code></pre>
<p><strong>Consider including:</strong> -
<code>.stamp/catalog.qs2</code> - Enables version history tracking
across team - <code>.stamp/versions/</code> - Useful for small datasets,
prohibitive for large files</p>
<p><strong>For large projects:</strong></p>
<pre><code><span><span class="co"># .gitignore</span></span>
<span><span class="va">.stamp</span><span class="op">/</span><span class="va">versions</span><span class="op">/</span>  <span class="co"># Too large for git</span></span>
<span><span class="va">.stamp</span><span class="op">/</span><span class="va">catalog.qs2</span>  <span class="co"># Local catalog only</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="backup-strategy">7.2 Backup Strategy<a class="anchor" aria-label="anchor" href="#backup-strategy"></a>
</h3>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Periodic catalog backup</span></span>
<span><span class="va">backup_dir</span> <span class="op">&lt;-</span> <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path.html" class="external-link">path</a></span><span class="op">(</span><span class="va">demo_dir</span>, <span class="st">"_backups"</span><span class="op">)</span></span>
<span><span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/create.html" class="external-link">dir_create</a></span><span class="op">(</span><span class="va">backup_dir</span><span class="op">)</span></span>
<span></span>
<span><span class="va">catalog_src</span> <span class="op">&lt;-</span> <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path.html" class="external-link">path</a></span><span class="op">(</span><span class="va">stamp_dir</span>, <span class="st">"catalog.qs2"</span><span class="op">)</span></span>
<span><span class="va">catalog_dst</span> <span class="op">&lt;-</span> <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path.html" class="external-link">path</a></span><span class="op">(</span><span class="va">backup_dir</span>, <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"catalog_%s.qs2"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.Date</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/copy.html" class="external-link">file_copy</a></span><span class="op">(</span><span class="va">catalog_src</span>, <span class="va">catalog_dst</span>, overwrite <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># For critical projects, also backup versions/</span></span>
<span><span class="va">versions_src</span> <span class="op">&lt;-</span> <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path.html" class="external-link">path</a></span><span class="op">(</span><span class="va">stamp_dir</span>, <span class="st">"versions"</span><span class="op">)</span></span>
<span><span class="va">versions_dst</span> <span class="op">&lt;-</span> <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path.html" class="external-link">path</a></span><span class="op">(</span><span class="va">backup_dir</span>, <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"versions_%s"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.Date</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/copy.html" class="external-link">dir_copy</a></span><span class="op">(</span><span class="va">versions_src</span>, <span class="va">versions_dst</span>, overwrite <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<hr>
</div>
</div>
<div class="section level2">
<h2 id="summary">8. Summary<a class="anchor" aria-label="anchor" href="#summary"></a>
</h2>
<p>The <code>.stamp/</code> directory is a <strong>robust, append-only
version store</strong> that:</p>
<p>✅ <strong>Persists across sessions</strong> - Re-running
<code><a href="../reference/st_init.html">st_init()</a></code> is safe<br>
✅ <strong>Tracks complete version history</strong> - Every save creates
an immutable snapshot<br>
✅ <strong>Enables lineage tracking</strong> - Parent relationships
preserved in <code>parents.json</code><br>
✅ <strong>Supports concurrent access</strong> - File-based locking
prevents corruption<br>
✅ <strong>Scales with retention policies</strong> - Auto-prune old
versions to manage disk space</p>
<p><strong>Key takeaways for users:</strong></p>
<ul>
<li>
<code>.stamp/</code> is created once and grows with each
version</li>
<li>Safe to re-initialize without losing history</li>
<li>Use <code><a href="../reference/st_versions.html">st_versions()</a></code>, <code><a href="../reference/st_info.html">st_info()</a></code>, and
<code>st_load(version=...)</code> to explore history</li>
<li>Configure retention policies to manage disk usage</li>
</ul>
<p><strong>Key takeaways for developers:</strong></p>
<ul>
<li>Catalog is the source of truth (two tables: artifacts,
versions)</li>
<li>Version snapshots are immutable and organized by relative path</li>
<li>All writes use atomic operations + locking for safety</li>
<li>Internal functions prefixed with <code>.st_</code> provide
infrastructure</li>
</ul>
<hr>
</div>
<div class="section level2">
<h2 id="further-reading">Further Reading<a class="anchor" aria-label="anchor" href="#further-reading"></a>
</h2>
<ul>
<li>
<code><a href="../articles/setup-and-basics.html">vignette("setup-and-basics", package = "stamp")</a></code> -
General introduction</li>
<li>
<code><a href="../articles/hashing-and-versions.html">vignette("hashing-and-versions", package = "stamp")</a></code> -
Deep dive into content hashing</li>
</ul>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by R.Andres Castaneda, Diana C. Garcia Rojas.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
