<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Lineage and Rebuilds • stamp</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Lineage and Rebuilds">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">stamp</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">0.0.2</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item"><a class="nav-link" href="../articles/index.html">Articles</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/randrescastaneda/stamp"><span class="fa fa-github"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Lineage and Rebuilds</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/randrescastaneda/stamp/blob/v0.0.2/vignettes/lineage-rebuilds.Rmd" class="external-link"><code>vignettes/lineage-rebuilds.Rmd</code></a></small>
      <div class="d-none name"><code>lineage-rebuilds.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Use development build when interactive *and* explicitly enabled via env var.</span></span>
<span><span class="va">dev_mode</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">"DEV_VIGNETTES"</span>, <span class="st">"false"</span><span class="op">)</span> <span class="op">==</span> <span class="st">"true"</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="va">dev_mode</span> <span class="op">&amp;&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">"pkgload"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">cli</span><span class="fu">::</span><span class="fu"><a href="https://cli.r-lib.org/reference/cli_abort.html" class="external-link">cli_inform</a></span><span class="op">(</span><span class="st">"loading with {.pkg pkgload}"</span><span class="op">)</span></span>
<span>  <span class="fu">pkgload</span><span class="fu">::</span><span class="fu"><a href="https://pkgload.r-lib.org/reference/load_all.html" class="external-link">load_all</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  <span class="co"># fall back to the installed package (the path CRAN, CI, and pkgdown take)</span></span>
<span>  <span class="fu">cli</span><span class="fu">::</span><span class="fu"><a href="https://cli.r-lib.org/reference/cli_abort.html" class="external-link">cli_inform</a></span><span class="op">(</span><span class="st">"loading with {.pkg library}"</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://randrescastaneda.github.io/stamp/">stamp</a></span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<pre><code><span><span class="co">## loading with <span style="color: #0000BB;">library</span></span></span></code></pre>
<p>This vignette shows how <strong>stamp</strong> captures
<strong>lineage</strong> (parents → children), how to detect
<strong>staleness</strong>, and how to <strong>plan &amp;
rebuild</strong> downstream artifacts in level order.</p>
<p>You’ll use:</p>
<ul>
<li>Lineage: <code><a href="../reference/st_children.html">st_children()</a></code>, <code><a href="../reference/st_lineage.html">st_lineage()</a></code>
</li>
<li>Staleness: <code><a href="../reference/st_is_stale.html">st_is_stale()</a></code>
</li>
<li>Planning: <code><a href="../reference/st_plan_rebuild.html">st_plan_rebuild()</a></code> (returns a plan
data.frame)</li>
<li>Rebuilding: <code><a href="../reference/st_register_builder.html">st_register_builder()</a></code>,
<code><a href="../reference/st_clear_builders.html">st_clear_builders()</a></code>, <code><a href="../reference/st_rebuild.html">st_rebuild()</a></code>
</li>
</ul>
<blockquote>
<p><strong>Strict vs. Propagate</strong> <em>Strict</em> checks actual
mismatch vs the parents’ <strong>current</strong> latest versions.
<em>Propagate</em> simulates change pushing downstream (A changes ⇒
schedule B ⇒ schedule C, etc.).</p>
</blockquote>
<p>A few implementation notes that clarify behavior used by the examples
below:</p>
<ul>
<li>Committed parents (the <code>parents.json</code> file inside a
version snapshot) are the authoritative record for lineage when present.
They are captured at commit time and are used for reproducible,
recursive lineage walking.</li>
<li>Sidecar parents (the <code>parents</code> field in the sidecar
metadata written next to the artifact file) are a lightweight
convenience that let you inspect first-level lineage before a snapshot
is committed. <code><a href="../reference/st_lineage.html">st_lineage()</a></code> falls back to sidecar parents
only for the immediate parent level when no snapshot is available;
recursive walking beyond level 1 requires snapshot-backed parents.</li>
</ul>
<p>This design keeps interactive workflows fast (sidecars are quick)
while preserving reproducible history once snapshots are written.</p>
<div class="section level2">
<h2 id="setup-a-tiny-graph-a-ba-cb">Setup a tiny graph A → B(A) → C(B)<a class="anchor" aria-label="anchor" href="#setup-a-tiny-graph-a-ba-cb"></a>
</h2>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/st_opts_reset.html">st_opts_reset</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/st_opts.html">st_opts</a></span><span class="op">(</span></span>
<span>  versioning <span class="op">=</span> <span class="st">"content"</span>,</span>
<span>  code_hash <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  store_file_hash <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  verify_on_load <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  meta_format <span class="op">=</span> <span class="st">"both"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #00BB00;">✔</span> stamp options updated</span></span>
<span><span class="co">##   versioning = <span style="color: #0000BB;">"content"</span>, code_hash = <span style="color: #0000BB;">"TRUE"</span>, store_file_hash = <span style="color: #0000BB;">"TRUE"</span>,</span></span>
<span><span class="co">##   verify_on_load = <span style="color: #0000BB;">"TRUE"</span>, meta_format = <span style="color: #0000BB;">"both"</span></span></span></code></pre>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">root</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/st_init.html">st_init</a></span><span class="op">(</span><span class="va">root</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #00BB00;">✔</span> stamp initialized</span></span>
<span><span class="co">##   root: /tmp/RtmpcS6x2Z</span></span>
<span><span class="co">##   state: /tmp/RtmpcS6x2Z/.stamp</span></span></code></pre>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># A</span></span>
<span><span class="va">pA</span> <span class="op">&lt;-</span> <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path.html" class="external-link">path</a></span><span class="op">(</span><span class="va">root</span>, <span class="st">"A.qs"</span><span class="op">)</span></span>
<span><span class="va">xA</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>a <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/st_save.html">st_save</a></span><span class="op">(</span><span class="va">xA</span>, <span class="va">pA</span>, code <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">z</span><span class="op">)</span> <span class="va">z</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #00BB00;">✔</span> Saved [<span style="color: #00BB00;">qs2</span>] → <span style="color: #0000BB;">/tmp/RtmpcS6x2Z/A.qs</span> @ version</span></span>
<span><span class="co">## <span style="color: #00BB00;">f62e1bcded4180cd</span></span></span></code></pre>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># B depends on A</span></span>
<span><span class="va">pB</span> <span class="op">&lt;-</span> <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path.html" class="external-link">path</a></span><span class="op">(</span><span class="va">root</span>, <span class="st">"B.qs"</span><span class="op">)</span></span>
<span><span class="va">xB</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/transform.html" class="external-link">transform</a></span><span class="op">(</span><span class="va">xA</span>, b <span class="op">=</span> <span class="va">a</span> <span class="op">*</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/st_save.html">st_save</a></span><span class="op">(</span></span>
<span>  <span class="va">xB</span>,</span>
<span>  <span class="va">pB</span>,</span>
<span>  code <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">z</span><span class="op">)</span> <span class="va">z</span>,</span>
<span>  parents <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>path <span class="op">=</span> <span class="va">pA</span>, version_id <span class="op">=</span> <span class="fu"><a href="../reference/st_latest.html">st_latest</a></span><span class="op">(</span><span class="va">pA</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #00BB00;">✔</span> Saved [<span style="color: #00BB00;">qs2</span>] → <span style="color: #0000BB;">/tmp/RtmpcS6x2Z/B.qs</span> @ version</span></span>
<span><span class="co">## <span style="color: #00BB00;">bd6fc4204dd3d296</span></span></span></code></pre>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># C depends on B</span></span>
<span><span class="va">pC</span> <span class="op">&lt;-</span> <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path.html" class="external-link">path</a></span><span class="op">(</span><span class="va">root</span>, <span class="st">"C.qs"</span><span class="op">)</span></span>
<span><span class="va">xC</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/transform.html" class="external-link">transform</a></span><span class="op">(</span><span class="va">xB</span>, c <span class="op">=</span> <span class="va">b</span> <span class="op">+</span> <span class="fl">1L</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/st_save.html">st_save</a></span><span class="op">(</span></span>
<span>  <span class="va">xC</span>,</span>
<span>  <span class="va">pC</span>,</span>
<span>  code <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">z</span><span class="op">)</span> <span class="va">z</span>,</span>
<span>  parents <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>path <span class="op">=</span> <span class="va">pB</span>, version_id <span class="op">=</span> <span class="fu"><a href="../reference/st_latest.html">st_latest</a></span><span class="op">(</span><span class="va">pB</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #00BB00;">✔</span> Saved [<span style="color: #00BB00;">qs2</span>] → <span style="color: #0000BB;">/tmp/RtmpcS6x2Z/C.qs</span> @ version</span></span>
<span><span class="co">## <span style="color: #00BB00;">81aedba25dc47598</span></span></span></code></pre>
<p>Note: after these saves each artifact has a sidecar (in
<code>stmeta/</code>) and snapshots under
<code>.stamp/versions/</code>.</p>
<p>Committed parents vs sidecar example</p>
<p>This short interactive example shows the difference between committed
parents (stored inside the version snapshot) and the light-weight
sidecar parents next to the artifact file. We deliberately remove the
committed snapshot for <code>B</code> to simulate a case where only the
sidecar remains; <code><a href="../reference/st_lineage.html">st_lineage()</a></code> will still return immediate
parents (level 1) by reading the sidecar, but recursive walking beyond
level 1 only uses snapshot-backed parents.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Remove committed snapshot for B to simulate a no-snapshot state</span></span>
<span><span class="va">vdir_b</span> <span class="op">&lt;-</span> <span class="fu">stamp</span><span class="fu">:::</span><span class="fu"><a href="../reference/dot-st_version_dir.html">.st_version_dir</a></span><span class="op">(</span><span class="va">pB</span>, <span class="fu"><a href="../reference/st_latest.html">st_latest</a></span><span class="op">(</span><span class="va">pB</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/file_access.html" class="external-link">dir_exists</a></span><span class="op">(</span><span class="va">vdir_b</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/delete.html" class="external-link">dir_delete</a></span><span class="op">(</span><span class="va">vdir_b</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Now st_info will show snapshot_dir = NA but sidecar present</span></span>
<span><span class="fu"><a href="../reference/st_info.html">st_info</a></span><span class="op">(</span><span class="va">pB</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## $sidecar</span></span>
<span><span class="co">## $sidecar$path</span></span>
<span><span class="co">## [1] "/tmp/RtmpcS6x2Z/B.qs"</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $sidecar$format</span></span>
<span><span class="co">## [1] "qs2"</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $sidecar$created_at</span></span>
<span><span class="co">## [1] "2025-11-10T22:12:55Z"</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $sidecar$size_bytes</span></span>
<span><span class="co">## [1] 216</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $sidecar$content_hash</span></span>
<span><span class="co">## [1] "57992c880141b360"</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $sidecar$code_hash</span></span>
<span><span class="co">## [1] "488e8fa49c740261"</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $sidecar$file_hash</span></span>
<span><span class="co">## [1] "3de32a31f5476755"</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $sidecar$code_label</span></span>
<span><span class="co">## NULL</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $sidecar$parents</span></span>
<span><span class="co">##                   path       version_id</span></span>
<span><span class="co">## 1 /tmp/RtmpcS6x2Z/A.qs f62e1bcded4180cd</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $sidecar$attrs</span></span>
<span><span class="co">## list()</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $catalog</span></span>
<span><span class="co">## $catalog$latest_version_id</span></span>
<span><span class="co">## [1] NA</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $catalog$n_versions</span></span>
<span><span class="co">## [1] 1</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $snapshot_dir</span></span>
<span><span class="co">## [1] NA</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $parents</span></span>
<span><span class="co">##                   path       version_id</span></span>
<span><span class="co">## 1 /tmp/RtmpcS6x2Z/A.qs f62e1bcded4180cd</span></span></code></pre>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># st_lineage will fall back to the sidecar for immediate parents (level 1)</span></span>
<span><span class="fu"><a href="../reference/st_lineage.html">st_lineage</a></span><span class="op">(</span><span class="va">pB</span>, depth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] level          child_path     child_version  parent_path    parent_version</span></span>
<span><span class="co">## &lt;0 rows&gt; (or 0-length row.names)</span></span></code></pre>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># But recursive lineage (depth &gt; 1) will only follow snapshot-backed parents</span></span>
<span><span class="co"># (no recursive walk available once snapshots are missing)</span></span>
<span><span class="fu"><a href="../reference/st_lineage.html">st_lineage</a></span><span class="op">(</span><span class="va">pB</span>, depth <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] level          child_path     child_version  parent_path    parent_version</span></span>
<span><span class="co">## &lt;0 rows&gt; (or 0-length row.names)</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="inspect-lineage">Inspect lineage<a class="anchor" aria-label="anchor" href="#inspect-lineage"></a>
</h2>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Immediate children of A (depth 1)</span></span>
<span><span class="fu"><a href="../reference/st_children.html">st_children</a></span><span class="op">(</span><span class="va">pA</span>, depth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##             child_path    child_version          parent_path   parent_version</span></span>
<span><span class="co">## 1 /tmp/RtmpcS6x2Z/B.qs bd6fc4204dd3d296 /tmp/RtmpcS6x2Z/A.qs f62e1bcded4180cd</span></span>
<span><span class="co">##   level</span></span>
<span><span class="co">## 1     1</span></span></code></pre>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Full lineage (parents of an artifact)</span></span>
<span><span class="fu"><a href="../reference/st_lineage.html">st_lineage</a></span><span class="op">(</span><span class="va">pC</span>, depth <span class="op">=</span> <span class="cn">Inf</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] level          child_path     child_version  parent_path    parent_version</span></span>
<span><span class="co">## &lt;0 rows&gt; (or 0-length row.names)</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="make-a-change-upstream-detect-staleness">Make a change upstream &amp; detect staleness<a class="anchor" aria-label="anchor" href="#make-a-change-upstream-detect-staleness"></a>
</h2>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Change A → new version</span></span>
<span><span class="va">xA2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/transform.html" class="external-link">transform</a></span><span class="op">(</span><span class="va">xA</span>, a <span class="op">=</span> <span class="va">a</span> <span class="op">+</span> <span class="fl">10L</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/st_save.html">st_save</a></span><span class="op">(</span><span class="va">xA2</span>, <span class="va">pA</span>, code <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">z</span><span class="op">)</span> <span class="va">z</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #00BB00;">✔</span> Saved [<span style="color: #00BB00;">qs2</span>] → <span style="color: #0000BB;">/tmp/RtmpcS6x2Z/A.qs</span> @ version</span></span>
<span><span class="co">## <span style="color: #00BB00;">1bd0558dde7f0026</span></span></span></code></pre>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Strict staleness</span></span>
<span><span class="fu"><a href="../reference/st_is_stale.html">st_is_stale</a></span><span class="op">(</span><span class="va">pB</span><span class="op">)</span> <span class="co"># TRUE (B's recorded A version is now old)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] FALSE</span></span></code></pre>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/st_is_stale.html">st_is_stale</a></span><span class="op">(</span><span class="va">pC</span><span class="op">)</span> <span class="co"># FALSE (C points to B, which hasn't changed yet)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] FALSE</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="plan-rebuilds">Plan rebuilds<a class="anchor" aria-label="anchor" href="#plan-rebuilds"></a>
</h2>
<p>Two strategies:</p>
<ul>
<li>
<strong>strict</strong>: only items whose <em>recorded</em> parent
IDs differ from parents’ <em>current latest</em>.</li>
<li>
<strong>propagate</strong>: assume targets will change and plan
descendants in BFS layers.</li>
</ul>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Strict: only B right now</span></span>
<span><span class="va">plan_strict</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/st_plan_rebuild.html">st_plan_rebuild</a></span><span class="op">(</span><span class="va">pA</span>, depth <span class="op">=</span> <span class="cn">Inf</span>, mode <span class="op">=</span> <span class="st">"strict"</span><span class="op">)</span></span>
<span><span class="va">plan_strict</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] level                 path                  reason               </span></span>
<span><span class="co">## [4] latest_version_before</span></span>
<span><span class="co">## &lt;0 rows&gt; (or 0-length row.names)</span></span></code></pre>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Propagate: includes B (level 1) and C (level 2)</span></span>
<span><span class="va">plan</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/st_plan_rebuild.html">st_plan_rebuild</a></span><span class="op">(</span><span class="va">pA</span>, depth <span class="op">=</span> <span class="cn">Inf</span>, mode <span class="op">=</span> <span class="st">"propagate"</span><span class="op">)</span></span>
<span><span class="va">plan</span></span></code></pre></div>
<pre><code><span><span class="co">##   level                 path           reason latest_version_before</span></span>
<span><span class="co">## 1     1 /tmp/RtmpcS6x2Z/B.qs upstream_changed                  &lt;NA&gt;</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="register-builders-and-rebuild-in-level-order">Register builders and rebuild in level order<a class="anchor" aria-label="anchor" href="#register-builders-and-rebuild-in-level-order"></a>
</h2>
<p>Builders are tiny functions that <strong>produce</strong> an artifact
from its parents. They receive <code>(path, parents)</code> and return a
list with at least <code>x = &lt;object&gt;</code>.</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Clear any previous registry</span></span>
<span><span class="fu"><a href="../reference/st_clear_builders.html">st_clear_builders</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #00BB00;">✔</span> Cleared all registered builders</span></span></code></pre>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Register a builder for B: rebuild from A's committed version</span></span>
<span><span class="fu"><a href="../reference/st_register_builder.html">st_register_builder</a></span><span class="op">(</span><span class="va">pB</span>, <span class="kw">function</span><span class="op">(</span><span class="va">path</span>, <span class="va">parents</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># parents is list(list(path=..., version_id=...))</span></span>
<span>  <span class="va">A</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/st_load_version.html">st_load_version</a></span><span class="op">(</span><span class="va">parents</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">path</span>, <span class="va">parents</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">version_id</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/transform.html" class="external-link">transform</a></span><span class="op">(</span><span class="va">A</span>, b <span class="op">=</span> <span class="va">a</span> <span class="op">*</span> <span class="fl">2</span><span class="op">)</span>,</span>
<span>    code <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">z</span><span class="op">)</span> <span class="va">z</span>,</span>
<span>    code_label <span class="op">=</span> <span class="st">"B &lt;- A * 2"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #00BB00;">✔</span> Registered builder for <span style="color: #00BB00;">/tmp/RtmpcS6x2Z/B.qs</span></span></span>
<span><span class="co">## (<span style="color: #00BB00;">default</span>)</span></span></code></pre>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Register a builder for C: rebuild from B's committed version</span></span>
<span><span class="fu"><a href="../reference/st_register_builder.html">st_register_builder</a></span><span class="op">(</span><span class="va">pC</span>, <span class="kw">function</span><span class="op">(</span><span class="va">path</span>, <span class="va">parents</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">B</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/st_load_version.html">st_load_version</a></span><span class="op">(</span><span class="va">parents</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">path</span>, <span class="va">parents</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">version_id</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/transform.html" class="external-link">transform</a></span><span class="op">(</span><span class="va">B</span>, c <span class="op">=</span> <span class="va">b</span> <span class="op">+</span> <span class="fl">1L</span><span class="op">)</span>,</span>
<span>    code <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">z</span><span class="op">)</span> <span class="va">z</span>,</span>
<span>    code_label <span class="op">=</span> <span class="st">"C &lt;- B + 1"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #00BB00;">✔</span> Registered builder for <span style="color: #00BB00;">/tmp/RtmpcS6x2Z/C.qs</span></span></span>
<span><span class="co">## (<span style="color: #00BB00;">default</span>)</span></span></code></pre>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Dry run first (uses registered builders found by st_rebuild when rebuild_fun is NULL)</span></span>
<span><span class="fu"><a href="../reference/st_rebuild.html">st_rebuild</a></span><span class="op">(</span><span class="va">plan</span>, dry_run <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #00BB00;">✔</span> Rebuild level <span style="color: #00BB00;">1</span>: 1 artifact</span></span>
<span><span class="co">##   • <span style="color: #00BB00;">/tmp/RtmpcS6x2Z/B.qs</span> (<span style="color: #00BB00;">upstream_changed</span>)</span></span>
<span><span class="co">##   DRY RUN</span></span>
<span><span class="co">## <span style="color: #00BB00;">✔</span> Rebuild summary</span></span>
<span><span class="co">##   dry_run 1</span></span></code></pre>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Now actually rebuild (will use registered builders)</span></span>
<span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/st_rebuild.html">st_rebuild</a></span><span class="op">(</span><span class="va">plan</span>, dry_run <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #00BB00;">✔</span> Rebuild level <span style="color: #00BB00;">1</span>: 1 artifact</span></span>
<span><span class="co">##   • <span style="color: #00BB00;">/tmp/RtmpcS6x2Z/B.qs</span> (<span style="color: #00BB00;">upstream_changed</span>)</span></span>
<span><span class="co">## <span style="color: #00BB00;">✔</span> Loaded ← <span style="color: #00BB00;">/tmp/RtmpcS6x2Z/A.qs</span> @ <span style="color: #00BB00;">1bd0558dde7f0026</span> [<span style="color: #00BB00;">qs2</span>]</span></span>
<span><span class="co">## <span style="color: #00BB00;">✔</span> Saved [<span style="color: #00BB00;">qs2</span>] → <span style="color: #0000BB;">/tmp/RtmpcS6x2Z/B.qs</span> @ version <span style="color: #00BB00;">49d19de1142e7a42</span></span></span>
<span><span class="co">## OK @ version <span style="color: #00BB00;">49d19de1142e7a42</span></span></span>
<span><span class="co">## <span style="color: #00BB00;">✔</span> Rebuild summary</span></span>
<span><span class="co">##   built 1</span></span></code></pre>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res</span></span></code></pre></div>
<pre><code><span><span class="co">##   level                 path           reason status       version_id msg</span></span>
<span><span class="co">## 1     1 /tmp/RtmpcS6x2Z/B.qs upstream_changed  built 49d19de1142e7a42</span></span></code></pre>
<p>After rebuilding B, <strong>C</strong> becomes strictly stale if
<strong>B</strong> changes again later. You can re-plan from B to keep
propagating:</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/st_is_stale.html">st_is_stale</a></span><span class="op">(</span><span class="va">pB</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] FALSE</span></span></code></pre>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/st_is_stale.html">st_is_stale</a></span><span class="op">(</span><span class="va">pC</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] FALSE</span></span></code></pre>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/st_plan_rebuild.html">st_plan_rebuild</a></span><span class="op">(</span><span class="va">pB</span>, depth <span class="op">=</span> <span class="cn">Inf</span>, mode <span class="op">=</span> <span class="st">"propagate"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   level                 path           reason latest_version_before</span></span>
<span><span class="co">## 1     1 /tmp/RtmpcS6x2Z/C.qs upstream_changed                  &lt;NA&gt;</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="inspect-snapshots-on-disk">Inspect snapshots on disk<a class="anchor" aria-label="anchor" href="#inspect-snapshots-on-disk"></a>
</h2>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vroot</span> <span class="op">&lt;-</span> <span class="fu">stamp</span><span class="fu">:::</span><span class="fu"><a href="../reference/dot-st_versions_root.html">.st_versions_root</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/dir_tree.html" class="external-link">dir_tree</a></span><span class="op">(</span><span class="va">vroot</span>, recurse <span class="op">=</span> <span class="cn">TRUE</span>, all <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #0000BB; font-weight: bold;">/tmp/RtmpcS6x2Z/.stamp/versions</span></span></span>
<span><span class="co">## ├── <span style="color: #0000BB; font-weight: bold;">A.qs</span></span></span>
<span><span class="co">## │   ├── <span style="color: #0000BB; font-weight: bold;">1bd0558dde7f0026</span></span></span>
<span><span class="co">## │   │   ├── artifact</span></span>
<span><span class="co">## │   │   ├── sidecar.json</span></span>
<span><span class="co">## │   │   └── sidecar.qs2</span></span>
<span><span class="co">## │   └── <span style="color: #0000BB; font-weight: bold;">f62e1bcded4180cd</span></span></span>
<span><span class="co">## │       ├── artifact</span></span>
<span><span class="co">## │       ├── sidecar.json</span></span>
<span><span class="co">## │       └── sidecar.qs2</span></span>
<span><span class="co">## ├── <span style="color: #0000BB; font-weight: bold;">B.qs</span></span></span>
<span><span class="co">## │   ├── <span style="color: #0000BB; font-weight: bold;">49d19de1142e7a42</span></span></span>
<span><span class="co">## │   │   ├── artifact</span></span>
<span><span class="co">## │   │   ├── parents.json</span></span>
<span><span class="co">## │   │   ├── sidecar.json</span></span>
<span><span class="co">## │   │   └── sidecar.qs2</span></span>
<span><span class="co">## │   └── <span style="color: #0000BB; font-weight: bold;">bd6fc4204dd3d296</span></span></span>
<span><span class="co">## │       ├── artifact</span></span>
<span><span class="co">## │       ├── parents.json</span></span>
<span><span class="co">## │       ├── sidecar.json</span></span>
<span><span class="co">## │       └── sidecar.qs2</span></span>
<span><span class="co">## └── <span style="color: #0000BB; font-weight: bold;">C.qs</span></span></span>
<span><span class="co">##     └── <span style="color: #0000BB; font-weight: bold;">81aedba25dc47598</span></span></span>
<span><span class="co">##         ├── artifact</span></span>
<span><span class="co">##         ├── parents.json</span></span>
<span><span class="co">##         ├── sidecar.json</span></span>
<span><span class="co">##         └── sidecar.qs2</span></span></code></pre>
<p><strong>Tip:</strong> <code>st_info(path)</code> summarizes sidecar,
catalog status, and the latest snapshot dir, plus parsed
<code>parents.json</code> from the committed snapshot (if present).</p>
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/st_info.html">st_info</a></span><span class="op">(</span><span class="va">pC</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## $sidecar</span></span>
<span><span class="co">## $sidecar$path</span></span>
<span><span class="co">## [1] "/tmp/RtmpcS6x2Z/C.qs"</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $sidecar$format</span></span>
<span><span class="co">## [1] "qs2"</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $sidecar$created_at</span></span>
<span><span class="co">## [1] "2025-11-10T22:12:55Z"</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $sidecar$size_bytes</span></span>
<span><span class="co">## [1] 229</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $sidecar$content_hash</span></span>
<span><span class="co">## [1] "502fb8918e46e3de"</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $sidecar$code_hash</span></span>
<span><span class="co">## [1] "488e8fa49c740261"</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $sidecar$file_hash</span></span>
<span><span class="co">## [1] "385e81fdcbfab7ed"</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $sidecar$code_label</span></span>
<span><span class="co">## NULL</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $sidecar$parents</span></span>
<span><span class="co">##                   path       version_id</span></span>
<span><span class="co">## 1 /tmp/RtmpcS6x2Z/B.qs f62e1bcded4180cd</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $sidecar$attrs</span></span>
<span><span class="co">## list()</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $catalog</span></span>
<span><span class="co">## $catalog$latest_version_id</span></span>
<span><span class="co">## [1] NA</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $catalog$n_versions</span></span>
<span><span class="co">## [1] 1</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $snapshot_dir</span></span>
<span><span class="co">## [1] NA</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $parents</span></span>
<span><span class="co">##                   path       version_id</span></span>
<span><span class="co">## 1 /tmp/RtmpcS6x2Z/B.qs f62e1bcded4180cd</span></span></code></pre>
<div class="section level3">
<h3 id="takeaways">Takeaways<a class="anchor" aria-label="anchor" href="#takeaways"></a>
</h3>
<ul>
<li>Use <strong>strict</strong> staleness to detect objective
mismatches.</li>
<li>Use <strong>propagate</strong> planning to build a full downstream
schedule.</li>
<li>Keep builders small, pure, and deterministic; they make rebuilds
trivial.</li>
</ul>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by R.Andres Castaneda.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
