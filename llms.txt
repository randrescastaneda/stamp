# stamp

Lightweight versioned artifact store for R with sidecar metadata,
pruning policies, and Hive-style partitions.

## Installation

You can install the development version of stamp from
[GitHub](https://github.com/) with:

``` r
# install.packages("devtools")
devtools::install_github("randrescastaneda/stamp")
```

## Quickstart

``` r
library(stamp)
root <- tempdir()
st_init(root)
#> ✔ stamp initialized
#>   root: C:/Users/wb535623/AppData/Local/Temp/5/Rtmps9BVCS
#>   state: C:/Users/wb535623/AppData/Local/Temp/5/Rtmps9BVCS/.stamp

p <- fs::path(root, "demo.qs")
x <- data.frame(id = 1:3, val = letters[1:3])

st_save(x, p, pk = "id", code = function(z) z)
#> ✔ Saved [qs] → 'C:/Users/wb535623/AppData/Local/Temp/5/Rtmps9BVCS/demo.qs' @
#>   version 9f17a32f99df9990
y <- st_load(p)
#> ✔ Loaded [qs] ← 'C:/Users/wb535623/AppData/Local/Temp/5/Rtmps9BVCS/demo.qs'
vrs <- st_versions(p)
head(vrs)
#>          version_id      artifact_id     content_hash        code_hash
#>              <char>           <char>           <char>           <char>
#> 1: 9f17a32f99df9990 526fcbc6552f1098 cdbe771e53841cf7 488e8fa49c740261
#>    size_bytes                  created_at sidecar_format
#>         <num>                      <char>         <char>
#> 1:        170 2025-12-22T10:40:28.932216Z           json

# Retention
st_opts(retain_versions = 2)
#> ✔ stamp options updated
#>   retain_versions = "2"
st_save(transform(x, val = toupper(val)), p, code = function(z) z)
#> ✔ Retention policy matched zero versions; nothing to prune.
#> ✔ Saved [qs] → 'C:/Users/wb535623/AppData/Local/Temp/5/Rtmps9BVCS/demo.qs' @
#>   version 68b91238470c74fc
vrs <- st_versions(p)
head(vrs)
#>          version_id      artifact_id     content_hash        code_hash
#>              <char>           <char>           <char>           <char>
#> 1: 68b91238470c74fc 526fcbc6552f1098 d2b54b7e265bb11f 488e8fa49c740261
#> 2: 9f17a32f99df9990 526fcbc6552f1098 cdbe771e53841cf7 488e8fa49c740261
#>    size_bytes                  created_at sidecar_format
#>         <num>                      <char>         <char>
#> 1:        149 2025-12-22T10:40:29.104312Z           json
#> 2:        170 2025-12-22T10:40:28.932216Z           json

# Partitions
base <- fs::path(root, "inputs/country_year")
st_save_part(
  data.frame(country = "PER", year = 2023, pop = 34.5),
  base,
  key = list(country = "PER", year = 2023),
  pk = c("country", "year")
)
#> ✔ Retention policy matched zero versions; nothing to prune.
#> ✔ Saved [qs2] →
#>   'C:/Users/wb535623/AppData/Local/Temp/5/Rtmps9BVCS/inputs/country_year/country=PER/year=2023/part.qs2'
#>   @ version 2201f3bf291ca2f2
st_list_parts(base)
#>                                                                                                   path
#> 1 C:/Users/wb535623/AppData/Local/Temp/5/Rtmps9BVCS/inputs/country_year/country=PER/year=2023/part.qs2
#>   country year
#> 1     PER 2023
st_load_parts(base, as = "rbind")
#> ✔ Loaded [qs2] ←
#>   'C:/Users/wb535623/AppData/Local/Temp/5/Rtmps9BVCS/inputs/country_year/country=PER/year=2023/part.qs2'
#>   country year  pop
#> 1     PER 2023 34.5
```

## Folder Structure

`stamp` creates two directories when you call
[`st_init()`](https://randrescastaneda.github.io/stamp/reference/st_init.md):

- **`.stamp/`** - Internal state directory containing:
  - `catalog.json` - Index of all artifacts and their versions
  - `versions/` - Version snapshots organized by artifact and version ID
  - `temp/` and `logs/` - Working directories
- **`.st_data/`** - Data folder where your actual files are stored:
  - Artifacts are organized as `.st_data/<filename>/<filename>`
  - Subdirectories work too: `.st_data/<subdir>/<filename>/<filename>`

### Path Handling

You can reference artifacts using:

1.  **Bare filenames** - `"data.qs2"` → stored in
    `.st_data/data.qs2/data.qs2`
2.  **Relative paths with subdirectories** - `"results/model.rds"` →
    stored in `.st_data/results/model.rds/model.rds`
3.  **Absolute paths under project root** - These are converted to
    relative paths for versioning

The data folder name is configurable via
`st_opts(data_folder = ".my_data")`.

### Example Structure

``` text
my_project/
├── .stamp/              # State directory (managed by stamp)
│   ├── catalog.json
│   └── versions/
│       └── <artifact_id>/
│           └── <version_id>/
│               ├── artifact
│               └── sidecar.json
└── .st_data/            # Data directory (your files)
    ├── data.qs2/
    │   └── data.qs2     # Current version
    └── results/
        └── model.rds/
            └── model.rds
```

## File Formats

`stamp` supports multiple serialization formats. The two binary formats
have distinct implementations:

| Extension | Format | Package Required                                   | Notes                                                |
|-----------|--------|----------------------------------------------------|------------------------------------------------------|
| `.qs2`    | qs2    | [qs2](https://github.com/qsbase/qs2)               | New qs2 binary format (recommended for new projects) |
| `.qs`     | qs     | [qs](https://github.com/qsbase/qs)                 | Legacy qs binary format                              |
| `.rds`    | rds    | (base R)                                           | R serialized format                                  |
| `.csv`    | csv    | [data.table](https://r-datatable.com)              | Comma-separated values                               |
| `.fst`    | fst    | [fst](http://www.fstpackage.org)                   | Fast columnar format                                 |
| `.json`   | json   | [jsonlite](https://jeroen.r-universe.dev/jsonlite) | JSON format                                          |

**Important**: `.qs` and `.qs2` are **different formats** and require
their respective packages. There is no automatic fallback between them.
If you attempt to save/load a `.qs2` file without
[qs2](https://github.com/qsbase/qs2) installed, `stamp` will abort with
a clear error message.

### Installing Format Packages

``` r
# For qs2 format support
install.packages("qs2")

# For legacy qs format support
install.packages("qs")

# For fst format support
install.packages("fst")
```

### Format Selection

`stamp` infers format from file extension by default:

``` r
# Uses qs2 format (requires {qs2})
st_save(data, "output.qs2")

# Uses qs format (requires {qs})
st_save(data, "output.qs")

# Uses RDS (base R, always available)
st_save(data, "output.rds")
```

You can also specify format explicitly:

``` r
st_save(data, "output", format = "qs2")
```

Why stamp? Sidecars: hashes, provenance, PKs.

Retention: keep latest N and/or recent days.

Partitions: Hive-style directories, easy bind & filter.

See vignettes for retention + partition details.

# Package index

## Core I/O

- [`st_init()`](https://randrescastaneda.github.io/stamp/reference/st_init.md)
  : Initialize stamp project structure
- [`st_opts()`](https://randrescastaneda.github.io/stamp/reference/st_opts.md)
  : Get or set package options
- [`st_opts_get()`](https://randrescastaneda.github.io/stamp/reference/st_opts_get.md)
  : Convenience getter (optional sugar)
- [`st_opts_reset()`](https://randrescastaneda.github.io/stamp/reference/st_opts_reset.md)
  : Reset all options to package defaults
- [`st_path()`](https://randrescastaneda.github.io/stamp/reference/st_path.md)
  : Declare a path (with optional format & partition hint)
- [`st_part_path()`](https://randrescastaneda.github.io/stamp/reference/st_part_path.md)
  : Build a concrete partition path under a base directory
- [`st_list_parts()`](https://randrescastaneda.github.io/stamp/reference/st_list_parts.md)
  : List available partitions under a base directory
- [`st_formats()`](https://randrescastaneda.github.io/stamp/reference/st_formats.md)
  : Inspect available formats
- [`st_register_format()`](https://randrescastaneda.github.io/stamp/reference/st_register_format.md)
  : Register or override a format handler
- [`st_save()`](https://randrescastaneda.github.io/stamp/reference/st_save.md)
  : Save an R object to disk with metadata & versioning (atomic move)
- [`st_save_part()`](https://randrescastaneda.github.io/stamp/reference/st_save_part.md)
  : Save a single partition (uses st_save under the hood)
- [`st_write_parts()`](https://randrescastaneda.github.io/stamp/reference/st_write_parts.md)
  : Auto-partition and save a dataset (Hive-style)
- [`st_load()`](https://randrescastaneda.github.io/stamp/reference/st_load.md)
  : Load an object from disk (format auto-detected; optional integrity
  checks)
- [`st_load_parts()`](https://randrescastaneda.github.io/stamp/reference/st_load_parts.md)
  : Load and row-bind partitioned data
- [`st_load_version()`](https://randrescastaneda.github.io/stamp/reference/st_load_version.md)
  : Load a specific version of an artifact
- [`st_restore()`](https://randrescastaneda.github.io/stamp/reference/st_restore.md)
  : Restore artifact to a previous version

## Versioning & Catalog

- [`st_hash_obj()`](https://randrescastaneda.github.io/stamp/reference/st_hash_obj.md)
  : Stable SipHash-1-3 of an R object
- [`st_versions()`](https://randrescastaneda.github.io/stamp/reference/st_versions.md)
  : List versions for an artifact path
- [`st_latest()`](https://randrescastaneda.github.io/stamp/reference/st_latest.md)
  : Get the latest version_id for an artifact path
- [`st_prune_versions()`](https://randrescastaneda.github.io/stamp/reference/st_prune_versions.md)
  : Prune stored versions according to a retention policy
- [`st_rebuild()`](https://randrescastaneda.github.io/stamp/reference/st_rebuild.md)
  : Rebuild artifacts from a plan (level order)
- [`st_plan_rebuild()`](https://randrescastaneda.github.io/stamp/reference/st_plan_rebuild.md)
  : Plan a rebuild of descendants when parents changed

## Lineage & Builders

- [`st_children()`](https://randrescastaneda.github.io/stamp/reference/st_children.md)
  : List children (reverse lineage) of an artifact
- [`st_lineage()`](https://randrescastaneda.github.io/stamp/reference/st_lineage.md)
  : Show immediate or recursive parents for an artifact
- [`st_builders()`](https://randrescastaneda.github.io/stamp/reference/st_builders.md)
  : List registered builders
- [`st_register_builder()`](https://randrescastaneda.github.io/stamp/reference/st_register_builder.md)
  : Register a builder for an artifact path
- [`st_clear_builders()`](https://randrescastaneda.github.io/stamp/reference/st_clear_builders.md)
  : Clear all builders (or only those for a given path)

## Metadata & PKs

- [`st_read_sidecar()`](https://randrescastaneda.github.io/stamp/reference/st_read_sidecar.md)
  : Read sidecar metadata (internal)
- [`st_inspect_pk()`](https://randrescastaneda.github.io/stamp/reference/st_inspect_pk.md)
  : Inspect primary-key of an artifact from its sidecar
- [`st_add_pk()`](https://randrescastaneda.github.io/stamp/reference/st_add_pk.md)
  : Add or repair primary-key metadata in an artifact sidecar
- [`st_get_pk()`](https://randrescastaneda.github.io/stamp/reference/st_get_pk.md)
  : Read primary-key keys from a data.frame or sidecar/meta list
- [`st_pk()`](https://randrescastaneda.github.io/stamp/reference/st_pk.md)
  : Normalize a primary-key specification
- [`st_with_pk()`](https://randrescastaneda.github.io/stamp/reference/st_with_pk.md)
  : Attach primary-key metadata to a data.frame (in-memory)

## Helpers

- [`st_changed()`](https://randrescastaneda.github.io/stamp/reference/st_changed.md)
  : Check whether an artifact would change if saved now
- [`st_changed_reason()`](https://randrescastaneda.github.io/stamp/reference/st_changed_reason.md)
  : Explain why an artifact would change
- [`st_should_save()`](https://randrescastaneda.github.io/stamp/reference/st_should_save.md)
  : Decide if a save should proceed given current st_opts() Uses
  versioning policy and code-change rule.
- [`st_is_stale()`](https://randrescastaneda.github.io/stamp/reference/st_is_stale.md)
  : Is a child artifact stale because its parents advanced?
- [`st_info()`](https://randrescastaneda.github.io/stamp/reference/st_info.md)
  : Inspect an artifact's current status (sidecar + catalog + snapshot
  location)
- [`st_filter()`](https://randrescastaneda.github.io/stamp/reference/st_filter.md)
  : Filter a data.frame by primary-key values (or arbitrary columns)
- [`st_alias_get()`](https://randrescastaneda.github.io/stamp/reference/st_alias_get.md)
  : Get a registered alias configuration
- [`st_alias_list()`](https://randrescastaneda.github.io/stamp/reference/st_alias_list.md)
  : List registered stamp aliases in the current session
- [`st_switch()`](https://randrescastaneda.github.io/stamp/reference/st_switch.md)
  : Switch the session's default alias

# Articles

### Basics

- [Setup and
  Basics](https://randrescastaneda.github.io/stamp/articles/setup-and-basics.md):
- [The .stamp Directory: Structure and
  Internals](https://randrescastaneda.github.io/stamp/articles/stamp-directory.md):
- [Hashing, Change Detection and
  Versions](https://randrescastaneda.github.io/stamp/articles/hashing-and-versions.md):
- [Lineage and
  Rebuilds](https://randrescastaneda.github.io/stamp/articles/lineage-rebuilds.md):

### Advanced Usage

- [Builders, Plans, and
  Rebuilds](https://randrescastaneda.github.io/stamp/articles/builders-plans.md):
- [Using Aliases with
  stamp](https://randrescastaneda.github.io/stamp/articles/using-alias.md):
- [Version Retention, Pruning, and Table
  Metadata](https://randrescastaneda.github.io/stamp/articles/version_retention_prune.md):
- [Working with Partitioned
  Datasets](https://randrescastaneda.github.io/stamp/articles/partitions.md):
