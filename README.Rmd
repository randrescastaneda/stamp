---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# stamp

<!-- badges: start -->
[![Codecov test coverage](https://codecov.io/gh/randrescastaneda/stamp/branch/master/graph/badge.svg)](https://app.codecov.io/gh/randrescastaneda/stamp?branch=master)
<!-- badges: end -->

Lightweight versioned artifact store for R with sidecar metadata, pruning policies,
and Hive-style partitions.


## Installation

You can install the development version of stamp from [GitHub](https://github.com/) with:

``` r
# install.packages("devtools")
devtools::install_github("randrescastaneda/stamp")
```

## Quickstart

```{r}
library(stamp)
root <- tempdir()
st_init(root)

p <- fs::path(root, "demo.qs")
x <- data.frame(id = 1:3, val = letters[1:3])

st_save(x, p, pk = "id", code = function(z) z)
y <- st_load(p)
vrs <- st_versions(p)
head(vrs)

# Retention
st_opts(retain_versions = 2)
st_save(transform(x, val = toupper(val)), p, code = function(z) z)
vrs <- st_versions(p)
head(vrs)

# Partitions
base <- fs::path(root, "inputs/country_year")
st_save_part(
  data.frame(country = "PER", year = 2023, pop = 34.5),
  base,
  key = list(country = "PER", year = 2023),
  pk = c("country", "year")
)
st_list_parts(base)
st_load_parts(base, as = "rbind")
```

## File Formats

`stamp` supports multiple serialization formats. The two binary formats have distinct implementations:

| Extension | Format | Package Required | Notes |
|-----------|--------|------------------|-------|
| `.qs2` | qs2 | `{qs2}` | New qs2 binary format (recommended for new projects) |
| `.qs` | qs | `{qs}` | Legacy qs binary format |
| `.rds` | rds | (base R) | R serialized format |
| `.csv` | csv | `{data.table}` | Comma-separated values |
| `.fst` | fst | `{fst}` | Fast columnar format |
| `.json` | json | `{jsonlite}` | JSON format |

**Important**: `.qs` and `.qs2` are **different formats** and require their respective packages. There is no automatic fallback between them. If you attempt to save/load a `.qs2` file without `{qs2}` installed, `stamp` will abort with a clear error message.

### Installing Format Packages

```r
# For qs2 format support
install.packages("qs2")

# For legacy qs format support
install.packages("qs")

# For fst format support
install.packages("fst")
```

### Format Selection

`stamp` infers format from file extension by default:

```r
# Uses qs2 format (requires {qs2})
st_save(data, "output.qs2")

# Uses qs format (requires {qs})
st_save(data, "output.qs")

# Uses RDS (base R, always available)
st_save(data, "output.rds")
```

You can also specify format explicitly:

```r
st_save(data, "output", format = "qs2")
```

Why stamp?
Sidecars: hashes, provenance, PKs.

Retention: keep latest N and/or recent days.

Partitions: Hive-style directories, easy bind & filter.

See vignettes for retention + partition details.
